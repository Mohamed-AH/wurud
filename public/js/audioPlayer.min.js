class AudioPlayer{constructor(){this.audio=document.getElementById("audio"),this.player=document.getElementById("audioPlayer"),this.currentLecture=null,this.isPlaying=!1,this.isDragging=!1,this.isTouchDragging=!1,this.initElements(),this.loadPreferences(),this.setupEventListeners(),window.audioPlayer=this}initElements(){this.titleEl=document.getElementById("playerLectureTitle"),this.sheikhEl=document.getElementById("playerSheikhName"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.playPauseIcon=document.getElementById("playPauseIcon"),this.skipBackwardBtn=document.getElementById("skipBackward"),this.skipForwardBtn=document.getElementById("skipForward"),this.closePlayerBtn=document.getElementById("closePlayerBtn"),this.progressContainer=document.getElementById("progressContainer"),this.progressBar=document.getElementById("progressBar"),this.progressHandle=document.getElementById("progressHandle"),this.currentTimeEl=document.getElementById("currentTime"),this.durationEl=document.getElementById("duration"),this.speedBtn=document.getElementById("speedBtn"),this.speedMenu=document.getElementById("speedMenu"),this.speedLabel=document.getElementById("speedLabel"),this.muteBtn=document.getElementById("muteBtn"),this.volumeIcon=document.getElementById("volumeIcon"),this.volumeSlider=document.getElementById("volumeSlider"),this.downloadBtn=document.getElementById("downloadBtn")}setupEventListeners(){this.audio.addEventListener("loadedmetadata",()=>this.onLoadedMetadata()),this.audio.addEventListener("timeupdate",()=>this.onTimeUpdate()),this.audio.addEventListener("ended",()=>this.onEnded()),this.audio.addEventListener("play",()=>this.onPlay()),this.audio.addEventListener("pause",()=>this.onPause()),this.audio.addEventListener("error",e=>this.onError(e)),this.playPauseBtn.addEventListener("click",()=>this.togglePlayPause()),this.skipBackwardBtn.addEventListener("click",()=>this.skip(-15)),this.skipForwardBtn.addEventListener("click",()=>this.skip(15)),this.closePlayerBtn.addEventListener("click",()=>this.close()),this.progressContainer.addEventListener("mousedown",e=>this.startDrag(e)),this.progressContainer.addEventListener("touchstart",e=>this.handleTouchStart(e),{passive:!1}),this.progressContainer.addEventListener("touchmove",e=>this.handleTouchMove(e),{passive:!1}),this.progressContainer.addEventListener("touchend",e=>this.handleTouchEnd(e),{passive:!1}),this.player.addEventListener("touchmove",e=>{e.target.closest(".progress-container")&&e.preventDefault()},{passive:!1}),this.speedBtn.addEventListener("click",()=>this.toggleSpeedMenu()),document.querySelectorAll(".speed-option").forEach(e=>{e.addEventListener("click",e=>this.setSpeed(parseFloat(e.target.dataset.speed)))}),this.muteBtn.addEventListener("click",()=>this.toggleMute()),this.volumeSlider.addEventListener("input",e=>this.setVolume(e.target.value)),document.addEventListener("click",e=>{e.target.closest(".speed-control")||this.speedMenu.classList.add("hidden")}),document.addEventListener("keydown",e=>this.handleKeyboard(e))}play(e,t){console.log("â–¶ï¸ Playing lecture:",e,t),this.currentLecture={id:e,...t},this.titleEl.textContent=t.title||t.titleArabic||"Unknown",this.sheikhEl.textContent=t.sheikh||"";const i=`/stream/${e}`;this.audio.src=i,this.downloadBtn.href=`/download/${e}`,this.downloadBtn.style.display="block",this.show();const s=this.getSavedPosition(e);s>0&&(this.audio.currentTime=s),this.audio.play().catch(e=>{console.error("âŒ Playback error:",e),alert("Could not play audio. Please check if the file exists.")})}togglePlayPause(){this.audio.paused?this.audio.play():this.audio.pause()}skip(e){this.audio.currentTime=Math.max(0,Math.min(this.audio.duration,this.audio.currentTime+e))}seek(e){if(!this.audio.duration||isNaN(this.audio.duration))return;const t=this.progressContainer.getBoundingClientRect(),i=Math.max(0,Math.min(1,(e.clientX-t.left)/t.width)),s=i*this.audio.duration;this.progressBar.style.width=100*i+"%",this.currentTimeEl.textContent=this.formatTime(s),this.audio.currentTime=s}startDrag(e){e.preventDefault(),this.isDragging=!0,this.progressContainer.classList.add("dragging"),document.body.classList.add("audio-seeking"),this.seek(e);const t=e=>{this.isDragging&&this.seek(e)},i=()=>{this.isDragging=!1,this.progressContainer.classList.remove("dragging"),document.body.classList.remove("audio-seeking"),document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",i)}handleTouchStart(e){e.preventDefault(),this.isTouchDragging=!0,this.progressContainer.classList.add("dragging"),document.body.classList.add("audio-seeking"),this.seekFromTouch(e)}handleTouchMove(e){this.isTouchDragging&&(e.preventDefault(),this.seekFromTouch(e))}handleTouchEnd(e){this.isTouchDragging=!1,this.progressContainer.classList.remove("dragging"),document.body.classList.remove("audio-seeking")}seekFromTouch(e){if(!this.audio.duration||isNaN(this.audio.duration))return;const t=e.touches[0]||e.changedTouches[0];if(!t)return;const i=this.progressContainer.getBoundingClientRect(),s=Math.max(0,Math.min(1,(t.clientX-i.left)/i.width)),o=s*this.audio.duration;this.progressBar.style.width=100*s+"%",this.currentTimeEl.textContent=this.formatTime(o),this.audio.currentTime=o}toggleSpeedMenu(){this.speedMenu.classList.toggle("hidden")}setSpeed(e){this.audio.playbackRate=e,this.speedLabel.textContent=`${e}x`,document.querySelectorAll(".speed-option").forEach(t=>{t.classList.toggle("active",parseFloat(t.dataset.speed)===e)}),localStorage.setItem("audioPlayerSpeed",e),this.speedMenu.classList.add("hidden")}toggleMute(){this.audio.muted=!this.audio.muted,this.updateVolumeIcon()}setVolume(e){this.audio.volume=e/100,this.audio.muted=!1,this.updateVolumeIcon(),localStorage.setItem("audioPlayerVolume",e)}updateVolumeIcon(){this.audio.muted||0===this.audio.volume?this.volumeIcon.textContent="ðŸ”‡":this.audio.volume<.5?this.volumeIcon.textContent="ðŸ”‰":this.volumeIcon.textContent="ðŸ”Š"}show(){this.player.classList.remove("hidden"),document.body.style.paddingBottom="140px"}close(){this.audio.pause(),this.player.classList.add("hidden"),document.body.style.paddingBottom="0",this.currentLecture&&this.savePosition(this.currentLecture.id,this.audio.currentTime)}onLoadedMetadata(){this.durationEl.textContent=this.formatTime(this.audio.duration),this.currentLecture&&this.audio.duration>0&&this.verifyDuration(this.currentLecture.id,this.audio.duration)}async verifyDuration(e,t){const i=`duration_verified_${e}`;if(!localStorage.getItem(i))try{const s=await fetch(`/api/lectures/${e}/verify-duration`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({duration:t})}),o=await s.json();o.success&&(localStorage.setItem(i,"true"),o.updated?console.log(`âœ… Duration corrected: ${o.oldDuration}s â†’ ${o.newDuration}s`):o.verified&&console.log(`âœ… Duration verified: ${Math.round(t)}s`))}catch(e){console.warn("Duration verification failed:",e.message)}}onTimeUpdate(){if(this.isDragging||this.isTouchDragging)return;const e=this.audio.currentTime/this.audio.duration*100;this.progressBar.style.width=`${e}%`,this.currentTimeEl.textContent=this.formatTime(this.audio.currentTime),this.currentLecture&&this.audio.currentTime%5<.5&&this.savePosition(this.currentLecture.id,this.audio.currentTime)}onEnded(){this.playPauseIcon.textContent="â–¶",this.isPlaying=!1,this.currentLecture&&this.savePosition(this.currentLecture.id,0)}onPlay(){this.playPauseIcon.textContent="â¸",this.isPlaying=!0}onPause(){this.playPauseIcon.textContent="â–¶",this.isPlaying=!1}onError(e){console.error("âŒ Audio error:",e),alert("Error playing audio. The file may not exist or is not accessible.")}handleKeyboard(e){if(!this.player.classList.contains("hidden")&&"INPUT"!==e.target.tagName)switch(e.key){case" ":e.preventDefault(),this.togglePlayPause();break;case"ArrowLeft":e.preventDefault(),this.skip(-15);break;case"ArrowRight":e.preventDefault(),this.skip(15);break;case"m":case"M":this.toggleMute()}}formatTime(e){if(!e||isNaN(e))return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}savePosition(e,t){try{localStorage.setItem(`audioPlayer_pos_${e}`,t)}catch(e){console.warn("Could not save position:",e)}}getSavedPosition(e){try{return parseFloat(localStorage.getItem(`audioPlayer_pos_${e}`))||0}catch(e){return 0}}loadPreferences(){const e=localStorage.getItem("audioPlayerVolume");null!==e&&(this.audio.volume=e/100,this.volumeSlider.value=e);const t=localStorage.getItem("audioPlayerSpeed");null!==t&&this.setSpeed(parseFloat(t))}}console.log("ðŸŽµ Audio Player script loaded"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("ðŸŽµ Initializing Audio Player..."),window.audioPlayer=new AudioPlayer,console.log("âœ… Audio Player initialized:",window.audioPlayer)}):(console.log("ðŸŽµ Initializing Audio Player (already loaded)..."),window.audioPlayer=new AudioPlayer,console.log("âœ… Audio Player initialized:",window.audioPlayer));