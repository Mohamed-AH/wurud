<!DOCTYPE html>
<html lang="<%= adminLocale %>" dir="<%= adminDir %>">
<head>
  <%- include('partials/head') %>
  <title><%= t('admin_analytics') %> - <%= t('admin_title') %></title>
  <style>
    .page-title {
      font-size: 28px;
      margin-bottom: 24px;
      color: #2C3E35;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-card h3 {
      color: #666;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #1A5F5A;
    }

    .stat-card .sub-value {
      font-size: 14px;
      color: #888;
      margin-top: 4px;
    }

    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-bottom: 24px;
    }

    .section h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #2C3E35;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    [dir="rtl"] .section h2 {
      flex-direction: row-reverse;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .rank {
      color: #888;
      font-weight: 600;
    }

    .toggle-section {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .toggle-section h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #333;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    [dir="rtl"] .checkbox-label {
      flex-direction: row-reverse;
    }

    .checkbox-label input {
      width: 18px;
      height: 18px;
    }

    .status-public {
      background: #d4edda;
      color: #155724;
    }

    .status-hidden {
      background: #fff3cd;
      color: #856404;
    }

    .threshold-info {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    [dir="rtl"] .btn-secondary {
      margin-right: 10px;
      margin-left: 0;
    }

    [dir="ltr"] .btn-secondary {
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <%- include('partials/header', { activePage: 'analytics' }) %>

  <main class="admin-container">
    <h1 class="page-title"><%= t('admin_analytics') %></h1>

    <!-- Overview Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3><%= adminLocale === 'ar' ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª' : 'Total Page Views' %></h3>
        <div class="value"><%= summary.pageViews.total.toLocaleString() %></div>
        <div class="sub-value"><%= adminLocale === 'ar' ? 'Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…:' : 'Last 7 days:' %> <%= summary.pageViews.last7Days.toLocaleString() %></div>
      </div>
      <div class="stat-card">
        <h3><%= adminLocale === 'ar' ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª' : 'Total Plays' %></h3>
        <div class="value"><%= summary.lectures.totalPlays.toLocaleString() %></div>
      </div>
      <div class="stat-card">
        <h3><%= adminLocale === 'ar' ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª' : 'Total Downloads' %></h3>
        <div class="value"><%= summary.lectures.totalDownloads.toLocaleString() %></div>
      </div>
      <div class="stat-card">
        <h3><%= adminLocale === 'ar' ? 'Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©' : 'Published Lectures' %></h3>
        <div class="value"><%= summary.lectures.total %></div>
      </div>
    </div>

    <!-- Page Views by Type -->
    <div class="section">
      <h2><%= adminLocale === 'ar' ? 'ðŸ“„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…' : 'ðŸ“„ Page Views by Section' %></h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3><%= adminLocale === 'ar' ? 'Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Homepage' %></h3>
          <div class="value"><%= (summary.pageViews.byType.homepage || 0).toLocaleString() %></div>
        </div>
        <div class="stat-card">
          <h3><%= t('admin_lectures') %></h3>
          <div class="value"><%= (summary.pageViews.byType.lecture || 0).toLocaleString() %></div>
        </div>
        <div class="stat-card">
          <h3><%= t('admin_series') %></h3>
          <div class="value"><%= (summary.pageViews.byType.series || 0).toLocaleString() %></div>
        </div>
        <div class="stat-card">
          <h3><%= adminLocale === 'ar' ? 'Ø§Ù„ØªØµÙØ­' : 'Browse' %></h3>
          <div class="value"><%= (summary.pageViews.byType.browse || 0).toLocaleString() %></div>
        </div>
      </div>
    </div>

    <!-- Top Content -->
    <div class="grid-2">
      <div class="section">
        <h2><%= adminLocale === 'ar' ? 'ðŸŽ§ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØªØ´ØºÙŠÙ„Ø§Ù‹' : 'ðŸŽ§ Top Lectures by Plays' %></h2>
        <table class="admin-table">
          <thead>
            <tr>
              <th>#</th>
              <th><%= adminLocale === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Title' %></th>
              <th><%= adminLocale === 'ar' ? 'Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª' : 'Plays' %></th>
            </tr>
          </thead>
          <tbody>
            <% topLectures.forEach((lecture, index) => { %>
              <tr>
                <td class="rank"><%= index + 1 %></td>
                <td><%= lecture.titleArabic %></td>
                <td><%= lecture.playCount.toLocaleString() %></td>
              </tr>
            <% }) %>
            <% if (topLectures.length === 0) { %>
              <tr><td colspan="3" style="text-align: center; color: #888;"><%= adminLocale === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯' : 'No data yet' %></td></tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="section">
        <h2><%= adminLocale === 'ar' ? 'ðŸ“¥ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØªØ­Ù…ÙŠÙ„Ø§Ù‹' : 'ðŸ“¥ Top Lectures by Downloads' %></h2>
        <table class="admin-table">
          <thead>
            <tr>
              <th>#</th>
              <th><%= adminLocale === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Title' %></th>
              <th><%= adminLocale === 'ar' ? 'Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª' : 'Downloads' %></th>
            </tr>
          </thead>
          <tbody>
            <% topDownloads.forEach((lecture, index) => { %>
              <tr>
                <td class="rank"><%= index + 1 %></td>
                <td><%= lecture.titleArabic %></td>
                <td><%= lecture.downloadCount.toLocaleString() %></td>
              </tr>
            <% }) %>
            <% if (topDownloads.length === 0) { %>
              <tr><td colspan="3" style="text-align: center; color: #888;"><%= adminLocale === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯' : 'No data yet' %></td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Pages -->
    <div class="section">
      <h2><%= adminLocale === 'ar' ? 'ðŸ” Ø£ÙƒØ«Ø± Ø§Ù„ØµÙØ­Ø§Øª Ø²ÙŠØ§Ø±Ø©' : 'ðŸ” Top Pages' %></h2>
      <table class="admin-table">
        <thead>
          <tr>
            <th>#</th>
            <th><%= adminLocale === 'ar' ? 'Ø§Ù„ØµÙØ­Ø©' : 'Page' %></th>
            <th><%= adminLocale === 'ar' ? 'Ø§Ù„Ù†ÙˆØ¹' : 'Type' %></th>
            <th><%= adminLocale === 'ar' ? 'Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª' : 'Views' %></th>
          </tr>
        </thead>
        <tbody>
          <% topPages.forEach((page, index) => { %>
            <tr>
              <td class="rank"><%= index + 1 %></td>
              <td><%= page._id %></td>
              <td><%= page.pageType %></td>
              <td><%= page.totalViews.toLocaleString() %></td>
            </tr>
          <% }) %>
          <% if (topPages.length === 0) { %>
            <tr><td colspan="4" style="text-align: center; color: #888;"><%= adminLocale === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯' : 'No data yet' %></td></tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- Visibility Settings -->
    <div class="section">
      <h2><%= adminLocale === 'ar' ? 'âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©' : 'âš™ï¸ Public Stats Visibility' %></h2>
      <p style="margin-bottom: 16px; color: #666;">
        <%= adminLocale === 'ar' ? 'Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.' : 'Control whether analytics stats are displayed publicly on the website.' %>
        <%= adminLocale === 'ar' ? 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:' : 'Current status:' %>
        <% if (shouldShowPublic) { %>
          <span class="badge badge-success"><%= adminLocale === 'ar' ? 'Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø¹Ø§Ù…Ø©' : 'Visible to Public' %></span>
        <% } else { %>
          <span class="badge badge-warning"><%= adminLocale === 'ar' ? 'Ù…Ø®ÙÙŠ Ø¹Ù† Ø§Ù„Ø¹Ø§Ù…Ø©' : 'Hidden from Public' %></span>
        <% } %>
      </p>

      <div class="toggle-section">
        <h3><%= adminLocale === 'ar' ? 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' : 'Settings' %></h3>
        <form action="/admin/analytics/settings" method="POST">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="showPublicStats" <%= settings.showPublicStats ? 'checked' : '' %>>
              <span><%= adminLocale === 'ar' ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ø¹Ø§Ù…Ø© (ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ù†ÙŠØ§)' : 'Force show stats publicly (override thresholds)' %></span>
            </label>
          </div>

          <div class="form-group">
            <label><%= adminLocale === 'ar' ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ´ØºÙŠÙ„Ø§Øª Ù„Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'Minimum Plays to Auto-Show' %></label>
            <input type="number" name="minPlaysToDisplay" value="<%= settings.minPlaysToDisplay %>" min="0" class="form-control" style="width: 150px;">
            <div class="threshold-info"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø­Ø§Ù„ÙŠ:' : 'Current:' %> <%= summary.lectures.totalPlays.toLocaleString() %> <%= adminLocale === 'ar' ? 'ØªØ´ØºÙŠÙ„' : 'plays' %></div>
          </div>

          <div class="form-group">
            <label><%= adminLocale === 'ar' ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ù„Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'Minimum Downloads to Auto-Show' %></label>
            <input type="number" name="minDownloadsToDisplay" value="<%= settings.minDownloadsToDisplay %>" min="0" class="form-control" style="width: 150px;">
            <div class="threshold-info"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø­Ø§Ù„ÙŠ:' : 'Current:' %> <%= summary.lectures.totalDownloads.toLocaleString() %> <%= adminLocale === 'ar' ? 'ØªØ­Ù…ÙŠÙ„' : 'downloads' %></div>
          </div>

          <div class="form-group">
            <label><%= adminLocale === 'ar' ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ù„Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'Minimum Page Views to Auto-Show' %></label>
            <input type="number" name="minPageViewsToDisplay" value="<%= settings.minPageViewsToDisplay %>" min="0" class="form-control" style="width: 150px;">
            <div class="threshold-info"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø­Ø§Ù„ÙŠ:' : 'Current:' %> <%= summary.pageViews.total.toLocaleString() %> <%= adminLocale === 'ar' ? 'Ù…Ø´Ø§Ù‡Ø¯Ø©' : 'page views' %></div>
          </div>

          <button type="submit" class="btn btn-primary"><%= t('admin_btn_save') %></button>
        </form>

        <form action="/admin/analytics/refresh-stats" method="POST" style="display: inline; margin-top: 16px;">
          <button type="submit" class="btn-secondary"><%= adminLocale === 'ar' ? 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©' : 'Refresh Cached Stats' %></button>
        </form>
      </div>
    </div>
  </main>
</body>
</html>
