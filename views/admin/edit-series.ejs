<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Duroos</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    .header {
      background: #1A5F5A;
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-nav { display: flex; align-items: center; gap: 16px; }
    .header-nav a { color: white; text-decoration: none; opacity: 0.9; }
    .header-nav a:hover { opacity: 1; }
    .container { max-width: 800px; margin: 0 auto; padding: 32px 24px; }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 32px;
    }
    .form-group {
      margin-bottom: 24px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2C3E35;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-left: 8px;
    }
    .btn-primary {
      background: #1A5F5A;
      color: white;
    }
    .btn-primary:hover {
      background: #145047;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }
    .lectures-section {
      margin-top: 48px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1A5F5A;
    }
    .lecture-count {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 14px;
    }
    .lectures-list {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .lecture-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      background: white;
      transition: background 0.2s;
    }
    .lecture-item:last-child {
      border-bottom: none;
    }
    .lecture-item:hover {
      background: #f8f9fa;
    }
    .lecture-item.dragging {
      opacity: 0.5;
      background: #e3f2fd;
    }
    .lecture-item.drag-over {
      border-top: 3px solid #1A5F5A;
    }
    .drag-handle {
      cursor: grab;
      color: #999;
      font-size: 18px;
      padding: 4px;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
    .lecture-order {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #1A5F5A;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }
    .lecture-info {
      flex: 1;
      min-width: 0;
    }
    .lecture-title {
      font-weight: 500;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .lecture-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .lecture-actions {
      display: flex;
      gap: 4px;
    }
    .move-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    .move-btn:hover {
      background: #1A5F5A;
      color: white;
      border-color: #1A5F5A;
    }
    .move-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .action-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s;
      text-decoration: none;
    }
    .edit-btn:hover {
      background: #1A5F5A;
      border-color: #1A5F5A;
    }
    .remove-btn {
      color: #dc3545;
      font-weight: bold;
    }
    .remove-btn:hover {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }
    .save-order-btn {
      margin-top: 16px;
      padding: 12px 24px;
      background: #1A5F5A;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: none;
    }
    .save-order-btn:hover {
      background: #145047;
    }
    .save-order-btn.visible {
      display: inline-block;
    }
    /* Unassociated Lectures Section */
    .unassociated-section {
      margin-top: 48px;
      padding-top: 32px;
      border-top: 2px dashed #ddd;
    }
    .section-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: #fff3e0;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .section-toggle:hover {
      background: #ffe0b2;
    }
    .section-toggle h2 {
      margin: 0;
      font-size: 18px;
      color: #e65100;
    }
    .toggle-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }
    .toggle-icon.open {
      transform: rotate(180deg);
    }
    .unassociated-content {
      display: none;
    }
    .unassociated-content.visible {
      display: block;
    }
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .search-box input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .unassociated-list {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .unassociated-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    .unassociated-item:last-child {
      border-bottom: none;
    }
    .unassociated-item:hover {
      background: #f8f9fa;
    }
    .unassociated-item .lecture-info {
      flex: 1;
    }
    .unassociated-item .lecture-title {
      font-weight: 500;
    }
    .unassociated-item .lecture-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .assign-form {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .assign-form input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }
    .assign-btn {
      padding: 6px 12px;
      background: #1A5F5A;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .assign-btn:hover {
      background: #145047;
    }
    .assign-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .no-unassociated {
      padding: 32px;
      text-align: center;
      color: #666;
    }
    .loading-spinner {
      text-align: center;
      padding: 32px;
      color: #666;
    }
    /* Create Series Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.visible {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-header h3 {
      margin: 0;
      color: #1A5F5A;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    .modal-close:hover {
      color: #333;
    }
    .create-series-btn {
      padding: 10px 20px;
      background: #D4AF37;
      color: #2C1810;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .create-series-btn:hover {
      background: #c9a033;
    }
    .status-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 8px;
    }
    .status-published {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status-draft {
      background: #fff3e0;
      color: #e65100;
    }
    /* Audio status indicators */
    .audio-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 6px;
    }
    .audio-has {
      background: #e3f2fd;
      color: #1565c0;
    }
    .audio-none {
      background: #ffebee;
      color: #c62828;
    }
    .audio-uploading {
      background: #fff8e1;
      color: #f57c00;
    }
    /* Inline upload styles */
    .upload-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #C19A6B;
      background: #fffbf0;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    .upload-btn:hover {
      background: #C19A6B;
      color: white;
    }
    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .lecture-upload-input {
      display: none;
    }
    .inline-progress {
      display: none;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }
    .inline-progress.visible {
      display: block;
    }
    .inline-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #1A5F5A, #2E8B57);
      width: 0%;
      transition: width 0.2s;
    }
    .inline-progress-bar.success {
      background: #4CAF50;
    }
    .inline-progress-bar.error {
      background: #f44336;
    }
    .empty-lectures {
      padding: 32px;
      text-align: center;
      color: #666;
    }
    .btn-add-lecture {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      background: #D4AF37;
      color: #2C1810;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-add-lecture:hover {
      background: #c9a033;
      transform: translateY(-1px);
    }
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #c3e6cb;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø©</h1>
    <div class="header-nav">
      <a href="/admin/dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
      <a href="/admin/manage">Ø¥Ø¯Ø§Ø±Ø©</a>
      <a href="/auth/logout">Ø®Ø±ÙˆØ¬</a>
    </div>
  </div>

  <div class="container">
    <% if (typeof success !== 'undefined' && success === 'lecture_added') { %>
      <div class="success-message">âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­</div>
    <% } %>
    <% if (typeof success !== 'undefined' && success === 'updated') { %>
      <div class="success-message">âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</div>
    <% } %>
    <% if (typeof error !== 'undefined' && error === 'add_failed') { %>
      <div class="error-message">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³</div>
    <% } %>
    <div class="card">
      <form method="POST" action="/admin/series/<%= series._id %>/edit">
        <div class="form-group">
          <label for="titleArabic">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© *</label>
          <input
            type="text"
            id="titleArabic"
            name="titleArabic"
            value="<%= series.titleArabic %>"
            required
          >
        </div>

        <div class="form-group">
          <label for="titleEnglish">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</label>
          <input
            type="text"
            id="titleEnglish"
            name="titleEnglish"
            value="<%= series.titleEnglish || '' %>"
          >
        </div>

        <div class="form-group">
          <label for="category">Ø§Ù„ØªØµÙ†ÙŠÙ (ÙŠØªØ­ÙƒÙ… Ø¨ÙÙ„ØªØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)</label>
          <%
            // Default to 'Other' if category is null/undefined
            const currentCategory = series.category || 'Other';
          %>
          <select id="category" name="category" style="background: #fffbf0; border: 2px solid #C19A6B;">
            <option value="Aqeedah" <%= currentCategory === 'Aqeedah' ? 'selected' : '' %>>Ø¹Ù‚ÙŠØ¯Ø©</option>
            <option value="Fiqh" <%= currentCategory === 'Fiqh' ? 'selected' : '' %>>ÙÙ‚Ù‡</option>
            <option value="Tafsir" <%= currentCategory === 'Tafsir' ? 'selected' : '' %>>ØªÙØ³ÙŠØ±</option>
            <option value="Hadith" <%= currentCategory === 'Hadith' ? 'selected' : '' %>>Ø­Ø¯ÙŠØ«</option>
            <option value="Seerah" <%= currentCategory === 'Seerah' ? 'selected' : '' %>>Ø³ÙŠØ±Ø©</option>
            <option value="Akhlaq" <%= currentCategory === 'Akhlaq' ? 'selected' : '' %>>Ø£Ø®Ù„Ø§Ù‚</option>
            <option value="Other" <%= currentCategory === 'Other' ? 'selected' : '' %>>Ø£Ø®Ø±Ù‰</option>
          </select>
          <p style="font-size: 12px; color: #C19A6B; margin-top: 4px; font-weight: 600;">
            âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙŠØ­Ø¯Ø¯ ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ù„Ø³Ù„Ø© ÙÙŠ ÙÙ„Ø§ØªØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          </p>
        </div>

        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
          <div style="display: flex; gap: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
            <%
              // Content TYPE tags only - subject/topic is handled by Category above
              const availableTags = ['series', 'lecture', 'khutba'];
              const tagLabels = {
                'series': 'Ø³Ù„Ø³Ù„Ø© Ø¯Ø±ÙˆØ³',
                'lecture': 'Ù…Ø­Ø§Ø¶Ø±Ø© Ù…Ù†ÙØ±Ø¯Ø©',
                'khutba': 'Ø®Ø·Ø¨Ø© Ø¬Ù…Ø¹Ø©'
              };
              const seriesTags = series.tags || [];
            %>
            <% availableTags.forEach(tag => { %>
              <div class="checkbox-group">
                <input
                  type="checkbox"
                  id="tag-<%= tag %>"
                  name="tags"
                  value="<%= tag %>"
                  <%= seriesTags.includes(tag) ? 'checked' : '' %>
                >
                <label for="tag-<%= tag %>" style="margin-bottom: 0; margin-right: 8px;"><%= tagLabels[tag] %></label>
              </div>
            <% }) %>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 8px;">
            ğŸ’¡ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¹Ù‚ÙŠØ¯Ø©ØŒ ÙÙ‚Ù‡ØŒ Ø¥Ù„Ø®)
          </p>
        </div>

        <div class="form-group">
          <label for="descriptionArabic">Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</label>
          <textarea
            id="descriptionArabic"
            name="descriptionArabic"
          ><%= series.descriptionArabic || '' %></textarea>
        </div>

        <div class="form-group">
          <label for="descriptionEnglish">Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</label>
          <textarea
            id="descriptionEnglish"
            name="descriptionEnglish"
          ><%= series.descriptionEnglish || '' %></textarea>
        </div>

        <div class="form-group">
          <label for="bookAuthor">Ø§Ù„Ù…Ø¤Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ÙƒØªØ§Ø¨</label>
          <input
            type="text"
            id="bookAuthor"
            name="bookAuthor"
            value="<%= series.bookAuthor || '' %>"
            placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø´ÙŠØ® Ø£Ø­Ù…Ø¯ Ø¨Ù† ÙŠØ­ÙŠÙ‰ Ø§Ù„Ù†Ø¬Ù…ÙŠ"
          >
          <p style="font-size: 12px; color: #666; margin-top: 4px;">
            ğŸ’¡ Ø§Ø³Ù… Ù…Ø¤Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø°ÙŠ ÙŠØ´Ø±Ø­Ù‡ Ø§Ù„Ø´ÙŠØ® (ÙŠØ¸Ù‡Ø± ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø³Ù„Ø©)
          </p>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
          <a href="/admin/manage" class="btn btn-secondary">â†©ï¸ Ø¥Ù„ØºØ§Ø¡</a>
        </div>
      </form>

      <!-- Lectures Reorder Section -->
      <div class="lectures-section">
        <div class="section-header">
          <h2 class="section-title">ğŸ“š ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h2>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span class="lecture-count"><%= lectures.length %> Ù…Ø­Ø§Ø¶Ø±Ø©</span>
            <a href="/admin/series/<%= series._id %>/quick-add-lecture" class="btn-add-lecture" title="Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯">
              + Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³
            </a>
          </div>
        </div>

        <% if (lectures && lectures.length > 0) { %>
          <div class="lectures-list" id="lecturesList">
            <% lectures.forEach((lecture, index) => { %>
              <div class="lecture-item" data-id="<%= lecture._id %>" draggable="true">
                <span class="drag-handle">â‹®â‹®</span>
                <div class="lecture-order"><%= index + 1 %></div>
                <div class="lecture-info">
                  <div class="lecture-title">
                    <span class="status-badge <%= lecture.published ? 'status-published' : 'status-draft' %>">
                      <%= lecture.published ? 'Ù…Ù†Ø´ÙˆØ±' : 'Ù…Ø³ÙˆØ¯Ø©' %>
                    </span>
                    <span class="audio-status <%= lecture.audioUrl ? 'audio-has' : 'audio-none' %>" id="audio-status-<%= lecture._id %>">
                      <%= lecture.audioUrl ? 'ğŸ”Š ØµÙˆØª' : 'âš ï¸ Ø¨Ø¯ÙˆÙ† ØµÙˆØª' %>
                    </span>
                    <%= lecture.titleArabic %>
                  </div>
                  <div class="lecture-meta">
                    <% if (lecture.lectureNumber) { %>
                      Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø³: <%= lecture.lectureNumber %> |
                    <% } %>
                    <% if (lecture.dateRecorded) { %>
                      Ø§Ù„ØªØ§Ø±ÙŠØ®: <%= new Date(lecture.dateRecorded).toLocaleDateString('ar-SA') %>
                    <% } %>
                    <% if (lecture.durationSeconds) { %>
                      | Ø§Ù„Ù…Ø¯Ø©: <%= Math.floor(lecture.durationSeconds / 60) %>:<%= String(lecture.durationSeconds % 60).padStart(2, '0') %>
                    <% } %>
                  </div>
                  <div class="inline-progress" id="progress-<%= lecture._id %>">
                    <div class="inline-progress-bar" id="progress-bar-<%= lecture._id %>"></div>
                  </div>
                </div>
                <div class="lecture-actions">
                  <input type="file" id="upload-input-<%= lecture._id %>" class="lecture-upload-input" accept=".mp3,.m4a,.aac,.wav,.ogg,.flac" onchange="uploadLectureAudio('<%= lecture._id %>', this)">
                  <button class="upload-btn" id="upload-btn-<%= lecture._id %>" onclick="document.getElementById('upload-input-<%= lecture._id %>').click()" title="Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ">ğŸ“¤</button>
                  <a href="/admin/lectures/<%= lecture._id %>/edit" class="action-btn edit-btn" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</a>
                  <button class="action-btn remove-btn" onclick="removeLectureFromSeries('<%= lecture._id %>', '<%= lecture.titleArabic.substring(0, 30) %>')" title="Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø³Ù„Ø©">âœ•</button>
                  <button class="move-btn" onclick="moveLecture('<%= lecture._id %>', 'up')" title="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø¹Ù„Ù‰" <%= index === 0 ? 'disabled' : '' %>>â–²</button>
                  <button class="move-btn" onclick="moveLecture('<%= lecture._id %>', 'down')" title="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø³ÙÙ„" <%= index === lectures.length - 1 ? 'disabled' : '' %>>â–¼</button>
                </div>
              </div>
            <% }); %>
          </div>

          <button class="save-order-btn" id="saveOrderBtn" onclick="saveOrder()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
        <% } else { %>
          <div class="lectures-list">
            <div class="empty-lectures">
              <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©</p>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Unassociated Lectures Section -->
      <div class="unassociated-section">
        <div class="section-toggle" onclick="toggleUnassociated()">
          <h2>ğŸ“ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø¯ÙˆÙ† Ø³Ù„Ø³Ù„Ø©</h2>
          <span class="toggle-icon" id="toggleIcon">â–¼</span>
        </div>
        <div class="unassociated-content" id="unassociatedContent">
          <button class="create-series-btn" onclick="openCreateSeriesModal()">
            + Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù„Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
          </button>
          <div class="search-box">
            <input type="text" id="searchUnassociated" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©..." oninput="filterUnassociated()">
          </div>
          <div class="unassociated-list" id="unassociatedList">
            <div class="loading-spinner">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Series Modal -->
  <div class="modal-overlay" id="createSeriesModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“š Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù„Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <button class="modal-close" onclick="closeCreateSeriesModal()">&times;</button>
      </div>
      <form id="createSeriesForm" onsubmit="submitCreateSeries(event)">
        <div class="form-group">
          <label for="newSeriesTitleArabic">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© *</label>
          <input type="text" id="newSeriesTitleArabic" required placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±Ø­ ÙƒØªØ§Ø¨ Ø§Ù„ØªÙˆØ­ÙŠØ¯">
        </div>
        <div class="form-group">
          <label for="newSeriesTitleEnglish">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</label>
          <input type="text" id="newSeriesTitleEnglish" placeholder="Example: Explanation of Kitab at-Tawhid">
        </div>
        <div class="form-group">
          <label for="newSeriesSheikh">Ø§Ù„Ø´ÙŠØ® *</label>
          <select id="newSeriesSheikh" required>
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´ÙŠØ® --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="newSeriesCategory">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select id="newSeriesCategory">
            <option value="Other">Ø£Ø®Ø±Ù‰</option>
            <option value="Aqeedah">Ø¹Ù‚ÙŠØ¯Ø©</option>
            <option value="Fiqh">ÙÙ‚Ù‡</option>
            <option value="Tafsir">ØªÙØ³ÙŠØ±</option>
            <option value="Hadith">Ø­Ø¯ÙŠØ«</option>
            <option value="Seerah">Ø³ÙŠØ±Ø©</option>
            <option value="Akhlaq">Ø£Ø®Ù„Ø§Ù‚</option>
          </select>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©</button>
          <button type="button" class="btn btn-secondary" onclick="closeCreateSeriesModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const seriesId = '<%= series._id %>';
    let orderChanged = false;

    // Drag and drop functionality
    const lecturesList = document.getElementById('lecturesList');
    if (lecturesList) {
      let draggedItem = null;

      lecturesList.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('lecture-item')) {
          draggedItem = e.target;
          e.target.classList.add('dragging');
        }
      });

      lecturesList.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('lecture-item')) {
          e.target.classList.remove('dragging');
          document.querySelectorAll('.lecture-item').forEach(item => {
            item.classList.remove('drag-over');
          });
          updateOrderNumbers();
        }
      });

      lecturesList.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(lecturesList, e.clientY);
        const dragging = document.querySelector('.dragging');

        document.querySelectorAll('.lecture-item').forEach(item => {
          item.classList.remove('drag-over');
        });

        if (afterElement) {
          afterElement.classList.add('drag-over');
          lecturesList.insertBefore(dragging, afterElement);
        } else {
          lecturesList.appendChild(dragging);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.lecture-item:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function moveLecture(lectureId, direction) {
      const item = document.querySelector(`.lecture-item[data-id="${lectureId}"]`);
      if (!item) return;

      const parent = item.parentNode;
      if (direction === 'up' && item.previousElementSibling) {
        parent.insertBefore(item, item.previousElementSibling);
      } else if (direction === 'down' && item.nextElementSibling) {
        parent.insertBefore(item.nextElementSibling, item);
      }

      updateOrderNumbers();
    }

    function updateOrderNumbers() {
      const items = document.querySelectorAll('.lecture-item');
      items.forEach((item, index) => {
        const orderBadge = item.querySelector('.lecture-order');
        if (orderBadge) {
          orderBadge.textContent = index + 1;
        }

        // Update move button states
        const upBtn = item.querySelector('.move-btn:first-child');
        const downBtn = item.querySelector('.move-btn:last-child');
        if (upBtn) upBtn.disabled = index === 0;
        if (downBtn) downBtn.disabled = index === items.length - 1;
      });

      orderChanged = true;
      document.getElementById('saveOrderBtn').classList.add('visible');
    }

    async function saveOrder() {
      const items = document.querySelectorAll('.lecture-item');
      const lectureIds = Array.from(items).map(item => item.dataset.id);

      const saveBtn = document.getElementById('saveOrderBtn');
      saveBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      saveBtn.disabled = true;

      try {
        const response = await fetch(`/admin/series/${seriesId}/reorder-lectures`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ lectureIds })
        });

        const result = await response.json();

        if (result.success) {
          saveBtn.textContent = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
          orderChanged = false;
          setTimeout(() => {
            saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯';
            saveBtn.classList.remove('visible');
            saveBtn.disabled = false;
          }, 2000);
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Save order error:', error);
        saveBtn.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸';
        saveBtn.disabled = false;
        setTimeout(() => {
          saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯';
        }, 2000);
      }
    }

    // Remove lecture from series (doesn't delete the lecture)
    async function removeLectureFromSeries(lectureId, title) {
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© "${title}..." Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©ØŸ\n\nÙ„Ù† ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ ÙÙ‚Ø· Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ø³Ù„Ø³Ù„Ø©.`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/lectures/${lectureId}/remove-from-series`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          // Remove the lecture item from the list
          const lectureItem = document.querySelector(`.lecture-item[data-id="${lectureId}"]`);
          if (lectureItem) {
            lectureItem.style.transition = 'opacity 0.3s, transform 0.3s';
            lectureItem.style.opacity = '0';
            lectureItem.style.transform = 'translateX(20px)';
            setTimeout(() => {
              lectureItem.remove();
              updateOrderNumbers();
              // Update lecture count
              const countSpan = document.querySelector('.lecture-count');
              if (countSpan) {
                const currentCount = parseInt(countSpan.textContent) - 1;
                countSpan.textContent = `${currentCount} Ù…Ø­Ø§Ø¶Ø±Ø©`;
              }
            }, 300);
          }
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Remove lecture error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
      }
    }

    // Warn before leaving if order changed
    window.addEventListener('beforeunload', (e) => {
      if (orderChanged) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // ========== Create Series Modal ==========
    let sheikhsLoaded = false;

    function openCreateSeriesModal() {
      document.getElementById('createSeriesModal').classList.add('visible');
      if (!sheikhsLoaded) {
        loadSheikhs();
      }
    }

    function closeCreateSeriesModal() {
      document.getElementById('createSeriesModal').classList.remove('visible');
    }

    async function loadSheikhs() {
      try {
        const response = await fetch('/admin/api/sheikhs');
        const data = await response.json();

        if (data.success) {
          const select = document.getElementById('newSeriesSheikh');
          data.sheikhs.forEach(sheikh => {
            const option = document.createElement('option');
            option.value = sheikh._id;
            option.textContent = sheikh.nameArabic;
            select.appendChild(option);
          });
          sheikhsLoaded = true;
        }
      } catch (error) {
        console.error('Load sheikhs error:', error);
      }
    }

    async function submitCreateSeries(event) {
      event.preventDefault();

      const titleArabic = document.getElementById('newSeriesTitleArabic').value.trim();
      const titleEnglish = document.getElementById('newSeriesTitleEnglish').value.trim();
      const sheikhId = document.getElementById('newSeriesSheikh').value;
      const category = document.getElementById('newSeriesCategory').value;

      if (!titleArabic || !sheikhId) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´ÙŠØ®');
        return;
      }

      const submitBtn = event.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';

      try {
        const response = await fetch('/admin/api/series/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            titleArabic,
            titleEnglish,
            sheikhId,
            category
          })
        });

        const result = await response.json();

        if (result.success) {
          closeCreateSeriesModal();
          // Redirect to the new series edit page
          if (confirm(`âœ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø© "${result.series.titleArabic}" Ø¨Ù†Ø¬Ø§Ø­.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŸ`)) {
            window.location.href = `/admin/series/${result.series._id}/edit`;
          }
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Create series error:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©';
      }
    }

    // Close modal on outside click
    document.getElementById('createSeriesModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCreateSeriesModal();
      }
    });

    // ========== Unassociated Lectures Section ==========
    let unassociatedLectures = [];
    let unassociatedLoaded = false;

    function toggleUnassociated() {
      const content = document.getElementById('unassociatedContent');
      const icon = document.getElementById('toggleIcon');

      content.classList.toggle('visible');
      icon.classList.toggle('open');

      // Load data on first open
      if (content.classList.contains('visible') && !unassociatedLoaded) {
        loadUnassociatedLectures();
      }
    }

    async function loadUnassociatedLectures() {
      const listEl = document.getElementById('unassociatedList');

      try {
        const response = await fetch('/admin/api/unassociated-lectures');
        const data = await response.json();

        if (data.success) {
          unassociatedLectures = data.lectures;
          unassociatedLoaded = true;
          renderUnassociatedLectures(unassociatedLectures);
        } else {
          listEl.innerHTML = '<div class="no-unassociated">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        }
      } catch (error) {
        console.error('Load unassociated error:', error);
        listEl.innerHTML = '<div class="no-unassociated">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
      }
    }

    function renderUnassociatedLectures(lectures) {
      const listEl = document.getElementById('unassociatedList');

      if (lectures.length === 0) {
        listEl.innerHTML = '<div class="no-unassociated">âœ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø©</div>';
        return;
      }

      listEl.innerHTML = lectures.map(lecture => `
        <div class="unassociated-item" data-id="${lecture._id}" data-title="${lecture.titleArabic || ''}">
          <div class="lecture-info">
            <div class="lecture-title">${lecture.titleArabic || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>
            <div class="lecture-meta">
              ${lecture.audioFileName ? 'ğŸ”Š ' + lecture.audioFileName : 'âš ï¸ Ø¨Ø¯ÙˆÙ† ØµÙˆØª'}
              ${lecture.duration ? ' | ' + formatDuration(lecture.duration) : ''}
            </div>
          </div>
          <div class="assign-form">
            <input type="number" id="num-${lecture._id}" placeholder="#" min="1" title="Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø³">
            <button class="assign-btn" onclick="assignLecture('${lecture._id}')">
              Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø³Ù„Ø©
            </button>
          </div>
        </div>
      `).join('');
    }

    function formatDuration(seconds) {
      if (!seconds) return '';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function filterUnassociated() {
      const searchTerm = document.getElementById('searchUnassociated').value.toLowerCase();

      const filtered = unassociatedLectures.filter(lecture => {
        const title = (lecture.titleArabic || '').toLowerCase();
        const audio = (lecture.audioFileName || '').toLowerCase();
        return title.includes(searchTerm) || audio.includes(searchTerm);
      });

      renderUnassociatedLectures(filtered);
    }

    async function assignLecture(lectureId) {
      const numInput = document.getElementById(`num-${lectureId}`);
      const lectureNumber = numInput ? numInput.value : null;
      const btn = event.target;

      btn.disabled = true;
      btn.textContent = 'â³...';

      try {
        const response = await fetch(`/admin/lectures/${lectureId}/assign-to-series`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            seriesId: seriesId,
            lectureNumber: lectureNumber || null
          })
        });

        const result = await response.json();

        if (result.success) {
          // Remove from unassociated list
          const item = document.querySelector(`.unassociated-item[data-id="${lectureId}"]`);
          if (item) {
            item.style.transition = 'opacity 0.3s, transform 0.3s';
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              item.remove();
              // Update local array
              unassociatedLectures = unassociatedLectures.filter(l => l._id !== lectureId);
              if (unassociatedLectures.length === 0) {
                document.getElementById('unassociatedList').innerHTML =
                  '<div class="no-unassociated">âœ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø©</div>';
              }
            }, 300);
          }

          // Show success and suggest refresh
          alert('âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù„Ù„Ø³Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.\nÙ‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª.');
        } else {
          btn.disabled = false;
          btn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø³Ù„Ø©';
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Assign lecture error:', error);
        btn.disabled = false;
        btn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø³Ù„Ø©';
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
      }
    }

    // ========== Inline Audio Upload ==========
    function uploadLectureAudio(lectureId, fileInput) {
      const file = fileInput.files[0];
      if (!file) return;

      const uploadBtn = document.getElementById(`upload-btn-${lectureId}`);
      const progressDiv = document.getElementById(`progress-${lectureId}`);
      const progressBar = document.getElementById(`progress-bar-${lectureId}`);
      const audioStatus = document.getElementById(`audio-status-${lectureId}`);

      // Disable upload button
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'â³';

      // Show progress bar
      progressDiv.classList.add('visible');
      progressBar.style.width = '0%';
      progressBar.className = 'inline-progress-bar';

      // Update status
      audioStatus.className = 'audio-status audio-uploading';
      audioStatus.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';

      // Create FormData
      const formData = new FormData();
      formData.append('audioFile', file);

      // Create XHR for progress tracking
      const xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = percent + '%';

          if (percent >= 100) {
            audioStatus.textContent = 'â³ Ù…Ø¹Ø§Ù„Ø¬Ø©...';
          }
        }
      });

      xhr.addEventListener('load', () => {
        try {
          const response = JSON.parse(xhr.responseText);

          if (xhr.status === 200 && response.success) {
            // Success
            progressBar.style.width = '100%';
            progressBar.classList.add('success');
            audioStatus.className = 'audio-status audio-has';
            audioStatus.textContent = 'ğŸ”Š ØµÙˆØª';

            // Show brief success message
            uploadBtn.textContent = 'âœ“';
            setTimeout(() => {
              uploadBtn.textContent = 'ğŸ“¤';
              uploadBtn.disabled = false;
              progressDiv.classList.remove('visible');
            }, 2000);

            // Verify duration from the uploaded URL
            verifyUploadedDuration(lectureId, response.audioUrl);

          } else {
            // Error
            showUploadError(lectureId, response.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
          }
        } catch (e) {
          showUploadError(lectureId, 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
        }

        // Reset file input
        fileInput.value = '';
      });

      xhr.addEventListener('error', () => {
        showUploadError(lectureId, 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
        fileInput.value = '';
      });

      xhr.addEventListener('timeout', () => {
        showUploadError(lectureId, 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©');
        fileInput.value = '';
      });

      // Send request
      xhr.open('POST', `/admin/api/lectures/${lectureId}/upload-audio`);
      xhr.timeout = 600000; // 10 minutes
      xhr.send(formData);
    }

    function showUploadError(lectureId, message) {
      const uploadBtn = document.getElementById(`upload-btn-${lectureId}`);
      const progressDiv = document.getElementById(`progress-${lectureId}`);
      const progressBar = document.getElementById(`progress-bar-${lectureId}`);
      const audioStatus = document.getElementById(`audio-status-${lectureId}`);

      progressBar.classList.add('error');
      audioStatus.className = 'audio-status audio-none';
      audioStatus.textContent = 'âŒ ÙØ´Ù„';

      uploadBtn.textContent = 'ğŸ“¤';
      uploadBtn.disabled = false;

      setTimeout(() => {
        progressDiv.classList.remove('visible');
        audioStatus.textContent = 'âš ï¸ Ø¨Ø¯ÙˆÙ† ØµÙˆØª';
      }, 3000);

      console.error('Upload error:', message);
    }

    function verifyUploadedDuration(lectureId, audioUrl) {
      const audio = new Audio();
      audio.src = audioUrl;
      audio.addEventListener('loadedmetadata', () => {
        const duration = Math.floor(audio.duration);

        // Update duration in lecture meta
        const lectureItem = document.querySelector(`.lecture-item[data-id="${lectureId}"]`);
        if (lectureItem) {
          const metaDiv = lectureItem.querySelector('.lecture-meta');
          if (metaDiv && !metaDiv.textContent.includes('Ø§Ù„Ù…Ø¯Ø©:')) {
            const mins = Math.floor(duration / 60);
            const secs = duration % 60;
            metaDiv.innerHTML += ` | Ø§Ù„Ù…Ø¯Ø©: ${mins}:${String(secs).padStart(2, '0')}`;
          }
        }

        // Send to server to update database
        fetch(`/api/lectures/${lectureId}/verify-duration`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duration: duration })
        }).catch(err => console.error('Duration verify error:', err));
      });
    }
  </script>
</body>
</html>
