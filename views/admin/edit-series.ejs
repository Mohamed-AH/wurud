<!DOCTYPE html>
<html lang="<%= adminLocale %>" dir="<%= adminDir %>">
<head>
  <%- include('partials/head') %>
  <title><%= adminLocale === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø©' : 'Edit Series' %> - <%= t('admin_title') %></title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    .header {
      background: #1A5F5A;
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-nav { display: flex; align-items: center; gap: 16px; }
    .header-nav a { color: white; text-decoration: none; opacity: 0.9; }
    .header-nav a:hover { opacity: 1; }
    .container { max-width: 800px; margin: 0 auto; padding: 32px 24px; }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 32px;
    }
    .form-group {
      margin-bottom: 24px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2C3E35;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-left: 8px;
    }
    .btn-primary {
      background: #1A5F5A;
      color: white;
    }
    .btn-primary:hover {
      background: #145047;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }
    .lectures-section {
      margin-top: 48px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1A5F5A;
    }
    .lecture-count {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 14px;
    }
    .lectures-list {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .lecture-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      background: white;
      transition: background 0.2s;
    }
    .lecture-item:last-child {
      border-bottom: none;
    }
    .lecture-item:hover {
      background: #f8f9fa;
    }
    .lecture-item.dragging {
      opacity: 0.5;
      background: #e3f2fd;
    }
    .lecture-item.drag-over {
      border-top: 3px solid #1A5F5A;
    }
    .drag-handle {
      cursor: grab;
      color: #999;
      font-size: 18px;
      padding: 4px;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
    .lecture-order {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #1A5F5A;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }
    .lecture-info {
      flex: 1;
      min-width: 0;
    }
    .lecture-title {
      font-weight: 500;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .lecture-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .lecture-actions {
      display: flex;
      gap: 4px;
    }
    .move-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    .move-btn:hover {
      background: #1A5F5A;
      color: white;
      border-color: #1A5F5A;
    }
    .move-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .action-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s;
      text-decoration: none;
    }
    .edit-btn:hover {
      background: #1A5F5A;
      border-color: #1A5F5A;
    }
    .remove-btn {
      color: #dc3545;
      font-weight: bold;
    }
    .remove-btn:hover {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }
    .save-order-btn {
      margin-top: 16px;
      padding: 12px 24px;
      background: #1A5F5A;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: none;
    }
    .save-order-btn:hover {
      background: #145047;
    }
    .save-order-btn.visible {
      display: inline-block;
    }
    /* Unassociated Lectures Section */
    .unassociated-section {
      margin-top: 48px;
      padding-top: 32px;
      border-top: 2px dashed #ddd;
    }
    .section-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: #fff3e0;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .section-toggle:hover {
      background: #ffe0b2;
    }
    .section-toggle h2 {
      margin: 0;
      font-size: 18px;
      color: #e65100;
    }
    .toggle-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }
    .toggle-icon.open {
      transform: rotate(180deg);
    }
    .unassociated-content {
      display: none;
    }
    .unassociated-content.visible {
      display: block;
    }
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .search-box input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .unassociated-list {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .unassociated-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    .unassociated-item:last-child {
      border-bottom: none;
    }
    .unassociated-item:hover {
      background: #f8f9fa;
    }
    .unassociated-item .lecture-info {
      flex: 1;
    }
    .unassociated-item .lecture-title {
      font-weight: 500;
    }
    .unassociated-item .lecture-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .assign-form {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .assign-form input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }
    .assign-btn {
      padding: 6px 12px;
      background: #1A5F5A;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .assign-btn:hover {
      background: #145047;
    }
    .assign-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .no-unassociated {
      padding: 32px;
      text-align: center;
      color: #666;
    }
    .loading-spinner {
      text-align: center;
      padding: 32px;
      color: #666;
    }
    /* Create Series Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.visible {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-header h3 {
      margin: 0;
      color: #1A5F5A;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    .modal-close:hover {
      color: #333;
    }
    .create-series-btn {
      padding: 10px 20px;
      background: #D4AF37;
      color: #2C1810;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .create-series-btn:hover {
      background: #c9a033;
    }
    .status-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 8px;
    }
    .status-published {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status-draft {
      background: #fff3e0;
      color: #e65100;
    }
    /* Audio status indicators */
    .audio-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 6px;
    }
    .audio-has {
      background: #e3f2fd;
      color: #1565c0;
    }
    .audio-none {
      background: #ffebee;
      color: #c62828;
    }
    .audio-uploading {
      background: #fff8e1;
      color: #f57c00;
    }
    /* Inline upload styles */
    .upload-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #C19A6B;
      background: #fffbf0;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    .upload-btn:hover {
      background: #C19A6B;
      color: white;
    }
    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .publish-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #2e7d32;
      background: #e8f5e9;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s;
    }
    .publish-btn:hover {
      background: #2e7d32;
      color: white;
    }
    .publish-btn.draft {
      border-color: #e65100;
      background: #fff3e0;
    }
    .publish-btn.draft:hover {
      background: #e65100;
      color: white;
    }
    .publish-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .lecture-upload-input {
      display: none;
    }
    .inline-progress {
      display: none;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }
    .inline-progress.visible {
      display: block;
    }
    .inline-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #1A5F5A, #2E8B57);
      width: 0%;
      transition: width 0.2s;
    }
    .inline-progress-bar.success {
      background: #4CAF50;
    }
    .inline-progress-bar.error {
      background: #f44336;
    }
    .empty-lectures {
      padding: 32px;
      text-align: center;
      color: #666;
    }
    .btn-add-lecture {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      background: #D4AF37;
      color: #2C1810;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-add-lecture:hover {
      background: #c9a033;
      transform: translateY(-1px);
    }
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #c3e6cb;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #f5c6cb;
    }
    /* Toggle Switch Styles */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    .toggle-container.hidden-series {
      background: #fff3e0;
      border-color: #e65100;
    }
    .toggle-switch {
      position: relative;
      width: 56px;
      height: 28px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 28px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: #1A5F5A;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(28px);
    }
    .toggle-label {
      font-weight: 600;
      color: #2C3E35;
    }
    .toggle-description {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .hidden-warning {
      display: none;
      padding: 8px 12px;
      background: #dc3545;
      color: white;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
    }
    .toggle-container.hidden-series .hidden-warning {
      display: block;
    }
  </style>
</head>
<body>
  <%- include('partials/header', { activePage: 'manage' }) %>

  <main class="admin-container">
    <% if (typeof success !== 'undefined' && success === 'lecture_added') { %>
      <div class="success-message"><%= adminLocale === 'ar' ? 'âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­' : 'âœ“ Lecture added successfully' %></div>
    <% } %>
    <% if (typeof success !== 'undefined' && success === 'updated') { %>
      <div class="success-message"><%= adminLocale === 'ar' ? 'âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'âœ“ Changes saved successfully' %></div>
    <% } %>
    <% if (typeof error !== 'undefined' && error === 'add_failed') { %>
      <div class="error-message"><%= adminLocale === 'ar' ? 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³' : 'âŒ Error adding lecture' %></div>
    <% } %>
    <div class="card">
      <form method="POST" action="/admin/series/<%= series._id %>/edit">
        <div class="form-group">
          <label for="titleArabic"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Title (Arabic)' %> *</label>
          <input
            type="text"
            id="titleArabic"
            name="titleArabic"
            value="<%= series.titleArabic %>"
            required
            dir="rtl"
            class="form-control"
          >
        </div>

        <div class="form-group">
          <label for="titleEnglish"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' : 'Title (English)' %></label>
          <input
            type="text"
            id="titleEnglish"
            name="titleEnglish"
            value="<%= series.titleEnglish || '' %>"
            dir="ltr"
            class="form-control"
          >
        </div>

        <div class="form-group">
          <label for="category"><%= adminLocale === 'ar' ? 'Ø§Ù„ØªØµÙ†ÙŠÙ (ÙŠØªØ­ÙƒÙ… Ø¨ÙÙ„ØªØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)' : 'Category (Controls homepage filter)' %></label>
          <%
            // Default to 'Other' if category is null/undefined
            const currentCategory = series.category || 'Other';
          %>
          <select id="category" name="category" class="form-control" style="background: #fffbf0; border: 2px solid #C19A6B;">
            <option value="Aqeedah" <%= currentCategory === 'Aqeedah' ? 'selected' : '' %>><%= adminLocale === 'ar' ? 'Ø¹Ù‚ÙŠØ¯Ø©' : 'Aqeedah' %></option>
            <option value="Fiqh" <%= currentCategory === 'Fiqh' ? 'selected' : '' %>><%= adminLocale === 'ar' ? 'ÙÙ‚Ù‡' : 'Fiqh' %></option>
            <option value="Tafsir" <%= currentCategory === 'Tafsir' ? 'selected' : '' %>><%= adminLocale === 'ar' ? 'ØªÙØ³ÙŠØ±' : 'Tafsir' %></option>
            <option value="Hadith" <%= currentCategory === 'Hadith' ? 'selected' : '' %>><%= adminLocale === 'ar' ? 'Ø­Ø¯ÙŠØ«' : 'Hadith' %></option>
            <option value="Seerah" <%= currentCategory === 'Seerah' ? 'selected' : '' %>><%= adminLocale === 'ar' ? 'Ø³ÙŠØ±Ø©' : 'Seerah' %></option>
            <option value="Akhlaq" <%= currentCategory === 'Akhlaq' ? 'selected' : '' %>><%= adminLocale === 'ar' ? 'Ø£Ø®Ù„Ø§Ù‚' : 'Akhlaq' %></option>
            <option value="Other" <%= currentCategory === 'Other' ? 'selected' : '' %>><%= adminLocale === 'ar' ? 'Ø£Ø®Ø±Ù‰' : 'Other' %></option>
          </select>
          <p style="font-size: 12px; color: #C19A6B; margin-top: 4px; font-weight: 600;">
            <%= adminLocale === 'ar' ? 'âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙŠØ­Ø¯Ø¯ ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ù„Ø³Ù„Ø© ÙÙŠ ÙÙ„Ø§ØªØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'âš ï¸ This field determines the series category in homepage filters' %>
          </p>
        </div>

        <div class="form-group">
          <label><%= adminLocale === 'ar' ? 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Content Type' %></label>
          <div style="display: flex; gap: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
            <%
              // Content TYPE tags only - subject/topic is handled by Category above
              const availableTags = ['series', 'lecture', 'khutba'];
              const tagLabels = adminLocale === 'ar' ? {
                'series': 'Ø³Ù„Ø³Ù„Ø© Ø¯Ø±ÙˆØ³',
                'lecture': 'Ù…Ø­Ø§Ø¶Ø±Ø© Ù…Ù†ÙØ±Ø¯Ø©',
                'khutba': 'Ø®Ø·Ø¨Ø© Ø¬Ù…Ø¹Ø©'
              } : {
                'series': 'Lecture Series',
                'lecture': 'Single Lecture',
                'khutba': 'Friday Sermon'
              };
              const seriesTags = series.tags || [];
            %>
            <% availableTags.forEach(tag => { %>
              <div class="checkbox-group">
                <input
                  type="checkbox"
                  id="tag-<%= tag %>"
                  name="tags"
                  value="<%= tag %>"
                  <%= seriesTags.includes(tag) ? 'checked' : '' %>
                >
                <label for="tag-<%= tag %>" style="margin-bottom: 0; margin-right: 8px;"><%= tagLabels[tag] %></label>
              </div>
            <% }) %>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 8px;">
            ğŸ’¡ <%= adminLocale === 'ar' ? 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¹Ù‚ÙŠØ¯Ø©ØŒ ÙÙ‚Ù‡ØŒ Ø¥Ù„Ø®)' : 'Content type (Category above determines the subject: Aqeedah, Fiqh, etc.)' %>
          </p>
        </div>

        <div class="form-group">
          <label for="descriptionArabic"><%= adminLocale === 'ar' ? 'Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Description (Arabic)' %></label>
          <textarea
            id="descriptionArabic"
            name="descriptionArabic"
            dir="rtl"
            class="form-control"
          ><%= series.descriptionArabic || '' %></textarea>
        </div>

        <div class="form-group">
          <label for="descriptionEnglish"><%= adminLocale === 'ar' ? 'Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' : 'Description (English)' %></label>
          <textarea
            id="descriptionEnglish"
            name="descriptionEnglish"
            dir="ltr"
            class="form-control"
          ><%= series.descriptionEnglish || '' %></textarea>
        </div>

        <div class="form-group">
          <label for="bookAuthor"><%= adminLocale === 'ar' ? 'Ø§Ù„Ù…Ø¤Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ÙƒØªØ§Ø¨' : 'Original Book Author' %></label>
          <input
            type="text"
            id="bookAuthor"
            name="bookAuthor"
            value="<%= series.bookAuthor || '' %>"
            placeholder="<%= adminLocale === 'ar' ? 'Ù…Ø«Ø§Ù„: Ø§Ù„Ø´ÙŠØ® Ø£Ø­Ù…Ø¯ Ø¨Ù† ÙŠØ­ÙŠÙ‰ Ø§Ù„Ù†Ø¬Ù…ÙŠ' : 'Example: Sheikh Ahmad ibn Yahya an-Najmi' %>"
            class="form-control"
          >
          <p style="font-size: 12px; color: #666; margin-top: 4px;">
            ğŸ’¡ <%= adminLocale === 'ar' ? 'Ø§Ø³Ù… Ù…Ø¤Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø°ÙŠ ÙŠØ´Ø±Ø­Ù‡ Ø§Ù„Ø´ÙŠØ® (ÙŠØ¸Ù‡Ø± ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø³Ù„Ø©)' : 'Name of the book author being explained by the sheikh (displayed on series page)' %>
          </p>
        </div>

        <div class="form-group">
          <label><%= adminLocale === 'ar' ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ù„Ù„Ø¹Ù…ÙˆÙ…' : 'Series Visibility' %></label>
          <div class="toggle-container <%= series.isVisible === false ? 'hidden-series' : '' %>" id="visibilityContainer">
            <label class="toggle-switch">
              <input type="checkbox" name="isVisible" id="isVisible" <%= series.isVisible !== false ? 'checked' : '' %> onchange="updateVisibilityUI()">
              <span class="toggle-slider"></span>
            </label>
            <div>
              <div class="toggle-label" id="visibilityLabel">
                <%= series.isVisible !== false ? (adminLocale === 'ar' ? 'ğŸ‘ï¸ Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ø¹Ù…ÙˆÙ…' : 'ğŸ‘ï¸ Visible to Public') : (adminLocale === 'ar' ? 'ğŸš« Ù…Ø®ÙÙŠØ©' : 'ğŸš« Hidden') %>
              </div>
              <div class="toggle-description">
                <%= adminLocale === 'ar' ? 'Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø±ØŒ Ù„Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ø³Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£Ùˆ ØµÙØ­Ø© Ø§Ù„ØªØµÙØ­ Ø£Ùˆ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹' : 'When disabled, the series will not appear on homepage, browse page, or sitemap' %>
              </div>
            </div>
          </div>
          <div class="hidden-warning" id="hiddenWarning" style="<%= series.isVisible !== false ? 'display: none;' : '' %>">
            <%= adminLocale === 'ar' ? 'âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ù…Ø®ÙÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ù† ØªØ¸Ù‡Ø± Ù„Ù„Ø²ÙˆØ§Ø±' : 'âš ï¸ This series is currently hidden and will not appear to visitors' %>
          </div>
        </div>

        <div class="form-group">
          <label><%= adminLocale === 'ar' ? 'Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Homepage Section' %></label>
          <div style="display:flex;gap:10px;align-items:flex-start;">
            <select id="sectionSelect" style="flex:1;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
              <option value=""><%= adminLocale === 'ar' ? '-- Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù… --' : '-- No Section --' %></option>
              <% if (typeof sections !== 'undefined' && sections) { %>
                <% sections.forEach(function(sec) { %>
                  <option value="<%= sec._id %>" <%= series.sectionId && series.sectionId.toString() === sec._id.toString() ? 'selected' : '' %>>
                    <%= sec.icon %> <%= adminLocale === 'ar' ? sec.title.ar : sec.title.en %>
                  </option>
                <% }) %>
              <% } %>
            </select>
            <button type="button" class="btn btn-primary" style="padding:10px 16px;font-size:13px;white-space:nowrap;" onclick="assignSection()"><%= adminLocale === 'ar' ? 'ØªØ¹ÙŠÙŠÙ†' : 'Assign' %></button>
          </div>
          <div style="font-size:12px;color:#888;margin-top:4px;">
            <%= adminLocale === 'ar' ? 'Ø­Ø¯Ø¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ¸Ù‡Ø± ÙÙŠÙ‡ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Select which homepage section this series appears in' %>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary"><%= adminLocale === 'ar' ? 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª' : 'ğŸ’¾ Save Changes' %></button>
          <a href="/admin/manage" class="btn btn-secondary"><%= adminLocale === 'ar' ? 'â†©ï¸ Ø¥Ù„ØºØ§Ø¡' : 'â†©ï¸ Cancel' %></a>
        </div>
      </form>

      <!-- Lectures Reorder Section -->
      <div class="lectures-section">
        <div class="section-header">
          <h2 class="section-title"><%= adminLocale === 'ar' ? 'ğŸ“š ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª' : 'ğŸ“š Reorder Lectures' %></h2>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span class="lecture-count"><%= lectures.length %> <%= adminLocale === 'ar' ? 'Ù…Ø­Ø§Ø¶Ø±Ø©' : 'lectures' %></span>
            <a href="/admin/series/<%= series._id %>/quick-add-lecture" class="btn-add-lecture" title="<%= adminLocale === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯' : 'Add new lecture' %>">
              + <%= adminLocale === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³' : 'Add Lecture' %>
            </a>
          </div>
        </div>

        <% if (lectures && lectures.length > 0) { %>
          <div class="lectures-list" id="lecturesList">
            <% lectures.forEach((lecture, index) => { %>
              <div class="lecture-item" data-id="<%= lecture._id %>" draggable="true">
                <span class="drag-handle">â‹®â‹®</span>
                <div class="lecture-order"><%= index + 1 %></div>
                <div class="lecture-info">
                  <div class="lecture-title">
                    <span class="status-badge <%= lecture.published ? 'status-published' : 'status-draft' %>">
                      <%= lecture.published ? (adminLocale === 'ar' ? 'Ù…Ù†Ø´ÙˆØ±' : 'Published') : (adminLocale === 'ar' ? 'Ù…Ø³ÙˆØ¯Ø©' : 'Draft') %>
                    </span>
                    <span class="audio-status <%= lecture.audioUrl ? 'audio-has' : 'audio-none' %>" id="audio-status-<%= lecture._id %>">
                      <%= lecture.audioUrl ? (adminLocale === 'ar' ? 'ğŸ”Š ØµÙˆØª' : 'ğŸ”Š Audio') : (adminLocale === 'ar' ? 'âš ï¸ Ø¨Ø¯ÙˆÙ† ØµÙˆØª' : 'âš ï¸ No Audio') %>
                    </span>
                    <%= adminLocale === 'ar' ? lecture.titleArabic : (lecture.titleEnglish || lecture.titleArabic) %>
                  </div>
                  <div class="lecture-meta">
                    <% if (lecture.lectureNumber) { %>
                      <%= adminLocale === 'ar' ? 'Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø³' : 'Lecture #' %>: <%= lecture.lectureNumber %> |
                    <% } %>
                    <% if (lecture.dateRecorded) { %>
                      <%= adminLocale === 'ar' ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date' %>: <%= new Date(lecture.dateRecorded).toLocaleDateString(adminLocale === 'ar' ? 'ar-SA' : 'en-US') %>
                    <% } %>
                    <% if (lecture.durationSeconds) { %>
                      | <%= adminLocale === 'ar' ? 'Ø§Ù„Ù…Ø¯Ø©' : 'Duration' %>: <%= Math.floor(lecture.durationSeconds / 60) %>:<%= String(lecture.durationSeconds % 60).padStart(2, '0') %>
                    <% } %>
                  </div>
                  <div class="inline-progress" id="progress-<%= lecture._id %>">
                    <div class="inline-progress-bar" id="progress-bar-<%= lecture._id %>"></div>
                  </div>
                </div>
                <div class="lecture-actions">
                  <input type="file" id="upload-input-<%= lecture._id %>" class="lecture-upload-input" accept=".mp3,.m4a,.aac,.wav,.ogg,.flac" onchange="uploadLectureAudio('<%= lecture._id %>', this)">
                  <button class="upload-btn" id="upload-btn-<%= lecture._id %>" onclick="document.getElementById('upload-input-<%= lecture._id %>').click()" title="<%= adminLocale === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ' : 'Upload audio file' %>">ğŸ“¤</button>
                  <button class="publish-btn <%= lecture.published ? '' : 'draft' %>" id="publish-btn-<%= lecture._id %>" onclick="togglePublish('<%= lecture._id %>')" title="<%= lecture.published ? (adminLocale === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø±' : 'Unpublish') : (adminLocale === 'ar' ? 'Ù†Ø´Ø±' : 'Publish') %>">
                    <%= lecture.published ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—¨' %>
                  </button>
                  <a href="/admin/lectures/<%= lecture._id %>/edit" class="action-btn edit-btn" title="<%= adminLocale === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Edit' %>">âœï¸</a>
                  <button class="action-btn remove-btn" onclick="removeLectureFromSeries('<%= lecture._id %>', '<%= lecture.titleArabic.substring(0, 30) %>')" title="<%= adminLocale === 'ar' ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø³Ù„Ø©' : 'Remove from series' %>">âœ•</button>
                  <button class="move-btn" onclick="moveLecture('<%= lecture._id %>', 'up')" title="<%= adminLocale === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø¹Ù„Ù‰' : 'Move up' %>" <%= index === 0 ? 'disabled' : '' %>>â–²</button>
                  <button class="move-btn" onclick="moveLecture('<%= lecture._id %>', 'down')" title="<%= adminLocale === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø³ÙÙ„' : 'Move down' %>" <%= index === lectures.length - 1 ? 'disabled' : '' %>>â–¼</button>
                </div>
              </div>
            <% }); %>
          </div>

          <button class="save-order-btn" id="saveOrderBtn" onclick="saveOrder()"><%= adminLocale === 'ar' ? 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯' : 'ğŸ’¾ Save New Order' %></button>
        <% } else { %>
          <div class="lectures-list">
            <div class="empty-lectures">
              <p><%= adminLocale === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©' : 'No lectures in this series' %></p>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Unassociated Lectures Section -->
      <div class="unassociated-section">
        <div class="section-toggle" onclick="toggleUnassociated()">
          <h2><%= adminLocale === 'ar' ? 'ğŸ“ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø¯ÙˆÙ† Ø³Ù„Ø³Ù„Ø©' : 'ğŸ“ Unassociated Lectures' %></h2>
          <span class="toggle-icon" id="toggleIcon">â–¼</span>
        </div>
        <div class="unassociated-content" id="unassociatedContent">
          <button class="create-series-btn" onclick="openCreateSeriesModal()">
            + <%= adminLocale === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù„Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'Create New Series' %>
          </button>
          <div class="search-box">
            <input type="text" id="searchUnassociated" placeholder="<%= adminLocale === 'ar' ? 'Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©...' : 'Search unassociated lectures...' %>" oninput="filterUnassociated()">
          </div>
          <div class="unassociated-list" id="unassociatedList">
            <div class="loading-spinner"><%= adminLocale === 'ar' ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'â³ Loading...' %></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Create Series Modal -->
  <div class="modal-overlay" id="createSeriesModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><%= adminLocale === 'ar' ? 'ğŸ“š Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù„Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'ğŸ“š Create New Series' %></h3>
        <button class="modal-close" onclick="closeCreateSeriesModal()">&times;</button>
      </div>
      <form id="createSeriesForm" onsubmit="submitCreateSeries(event)">
        <div class="form-group">
          <label for="newSeriesTitleArabic"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Title (Arabic)' %> *</label>
          <input type="text" id="newSeriesTitleArabic" required placeholder="<%= adminLocale === 'ar' ? 'Ù…Ø«Ø§Ù„: Ø´Ø±Ø­ ÙƒØªØ§Ø¨ Ø§Ù„ØªÙˆØ­ÙŠØ¯' : 'Example: Ø´Ø±Ø­ ÙƒØªØ§Ø¨ Ø§Ù„ØªÙˆØ­ÙŠØ¯' %>" dir="rtl" class="form-control">
        </div>
        <div class="form-group">
          <label for="newSeriesTitleEnglish"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' : 'Title (English)' %></label>
          <input type="text" id="newSeriesTitleEnglish" placeholder="Example: Explanation of Kitab at-Tawhid" dir="ltr" class="form-control">
        </div>
        <div class="form-group">
          <label for="newSeriesSheikh"><%= adminLocale === 'ar' ? 'Ø§Ù„Ø´ÙŠØ®' : 'Sheikh' %> *</label>
          <select id="newSeriesSheikh" required class="form-control">
            <option value=""><%= adminLocale === 'ar' ? '-- Ø§Ø®ØªØ± Ø§Ù„Ø´ÙŠØ® --' : '-- Select Sheikh --' %></option>
          </select>
        </div>
        <div class="form-group">
          <label for="newSeriesCategory"><%= adminLocale === 'ar' ? 'Ø§Ù„ØªØµÙ†ÙŠÙ' : 'Category' %></label>
          <select id="newSeriesCategory" class="form-control">
            <option value="Other"><%= adminLocale === 'ar' ? 'Ø£Ø®Ø±Ù‰' : 'Other' %></option>
            <option value="Aqeedah"><%= adminLocale === 'ar' ? 'Ø¹Ù‚ÙŠØ¯Ø©' : 'Aqeedah' %></option>
            <option value="Fiqh"><%= adminLocale === 'ar' ? 'ÙÙ‚Ù‡' : 'Fiqh' %></option>
            <option value="Tafsir"><%= adminLocale === 'ar' ? 'ØªÙØ³ÙŠØ±' : 'Tafsir' %></option>
            <option value="Hadith"><%= adminLocale === 'ar' ? 'Ø­Ø¯ÙŠØ«' : 'Hadith' %></option>
            <option value="Seerah"><%= adminLocale === 'ar' ? 'Ø³ÙŠØ±Ø©' : 'Seerah' %></option>
            <option value="Akhlaq"><%= adminLocale === 'ar' ? 'Ø£Ø®Ù„Ø§Ù‚' : 'Akhlaq' %></option>
          </select>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary"><%= adminLocale === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©' : 'Create Series' %></button>
          <button type="button" class="btn btn-secondary" onclick="closeCreateSeriesModal()"><%= adminLocale === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' %></button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const seriesId = '<%= series._id %>';
    let orderChanged = false;
    const isArabic = '<%= adminLocale %>' === 'ar';

    // Translated messages
    const msgs = {
      visiblePublic: isArabic ? 'ğŸ‘ï¸ Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ø¹Ù…ÙˆÙ…' : 'ğŸ‘ï¸ Visible to Public',
      hidden: isArabic ? 'ğŸš« Ù…Ø®ÙÙŠØ©' : 'ğŸš« Hidden',
      saving: isArabic ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'â³ Saving...',
      saved: isArabic ? 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸' : 'âœ… Saved',
      saveOrder: isArabic ? 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯' : 'ğŸ’¾ Save New Order',
      saveFailed: isArabic ? 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸' : 'âŒ Save Failed',
      confirmRemove: isArabic ? 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø©' : 'Do you want to remove',
      fromSeries: isArabic ? 'Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©ØŸ' : 'from this series?',
      removeNote: isArabic ? '\n\nÙ„Ù† ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ ÙÙ‚Ø· Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ø³Ù„Ø³Ù„Ø©.' : '\n\nThe lecture will not be deleted, only removed from the series.',
      removeFailed: isArabic ? 'ÙØ´Ù„ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ' : 'Failed to remove lecture: ',
      unknownError: isArabic ? 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' : 'Unknown error',
      removeError: isArabic ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©' : 'Error occurred while removing lecture',
      lecture: isArabic ? 'Ù…Ø­Ø§Ø¶Ø±Ø©' : 'lecture',
      noUnassociated: isArabic ? 'âœ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø©' : 'âœ“ No unassociated lectures',
      noTitle: isArabic ? 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†' : 'No title',
      noAudio: isArabic ? 'âš ï¸ Ø¨Ø¯ÙˆÙ† ØµÙˆØª' : 'âš ï¸ No audio',
      lectureNum: isArabic ? 'Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø³' : 'Lecture #',
      addToSeries: isArabic ? 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø³Ù„Ø©' : 'Add to Series',
      loadError: isArabic ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'Error loading data',
      connError: isArabic ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error',
      addSuccess: isArabic ? 'âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù„Ù„Ø³Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.\nÙ‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª.' : 'âœ“ Lecture added to series successfully.\nRefresh the page to see changes in the lecture list.',
      addFailed: isArabic ? 'ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ' : 'Failed to add lecture: ',
      publishFailed: isArabic ? 'ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø±' : 'Failed to change publish status',
      published: isArabic ? 'Ù…Ù†Ø´ÙˆØ±' : 'Published',
      draft: isArabic ? 'Ù…Ø³ÙˆØ¯Ø©' : 'Draft',
      uploading: isArabic ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...' : 'â³ Uploading...',
      processing: isArabic ? 'â³ Ù…Ø¹Ø§Ù„Ø¬Ø©...' : 'â³ Processing...',
      hasAudio: isArabic ? 'ğŸ”Š ØµÙˆØª' : 'ğŸ”Š Audio',
      uploadFailed: isArabic ? 'âŒ ÙØ´Ù„' : 'âŒ Failed',
      noAudioStatus: isArabic ? 'âš ï¸ Ø¨Ø¯ÙˆÙ† ØµÙˆØª' : 'âš ï¸ No Audio',
      duration: isArabic ? 'Ø§Ù„Ù…Ø¯Ø©' : 'Duration',
      selectSheikh: isArabic ? '-- Ø§Ø®ØªØ± Ø§Ù„Ø´ÙŠØ® --' : '-- Select Sheikh --',
      fillRequired: isArabic ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´ÙŠØ®' : 'Please enter title and select sheikh',
      creating: isArabic ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'â³ Creating...',
      createSeries: isArabic ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©' : 'Create Series',
      seriesCreated: isArabic ? 'âœ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©' : 'âœ“ Series created',
      goToEdit: isArabic ? 'Ø¨Ù†Ø¬Ø§Ø­.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŸ' : 'successfully.\n\nDo you want to go to the new series edit page?',
      createFailed: isArabic ? 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©: ' : 'Failed to create series: '
    };

    // Section assignment
    function assignSection() {
      const select = document.getElementById('sectionSelect');
      const sectionId = select.value;
      const seriesId = '<%= series._id %>';

      fetch(`/admin/series/${seriesId}/assign-section`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sectionId })
      })
      .then(res => {
        if (res.redirected) {
          window.location.href = res.url;
        } else {
          window.location.reload();
        }
      })
      .catch(() => alert(isArabic ? 'Ø­Ø¯Ø« Ø®Ø·Ø£' : 'An error occurred'));
    }

    // Visibility toggle UI update
    function updateVisibilityUI() {
      const checkbox = document.getElementById('isVisible');
      const container = document.getElementById('visibilityContainer');
      const label = document.getElementById('visibilityLabel');
      const warning = document.getElementById('hiddenWarning');

      if (checkbox.checked) {
        container.classList.remove('hidden-series');
        label.textContent = msgs.visiblePublic;
        warning.style.display = 'none';
      } else {
        container.classList.add('hidden-series');
        label.textContent = msgs.hidden;
        warning.style.display = 'block';
      }
    }

    // Drag and drop functionality
    const lecturesList = document.getElementById('lecturesList');
    if (lecturesList) {
      let draggedItem = null;

      lecturesList.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('lecture-item')) {
          draggedItem = e.target;
          e.target.classList.add('dragging');
        }
      });

      lecturesList.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('lecture-item')) {
          e.target.classList.remove('dragging');
          document.querySelectorAll('.lecture-item').forEach(item => {
            item.classList.remove('drag-over');
          });
          updateOrderNumbers();
        }
      });

      lecturesList.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(lecturesList, e.clientY);
        const dragging = document.querySelector('.dragging');

        document.querySelectorAll('.lecture-item').forEach(item => {
          item.classList.remove('drag-over');
        });

        if (afterElement) {
          afterElement.classList.add('drag-over');
          lecturesList.insertBefore(dragging, afterElement);
        } else {
          lecturesList.appendChild(dragging);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.lecture-item:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function moveLecture(lectureId, direction) {
      const item = document.querySelector(`.lecture-item[data-id="${lectureId}"]`);
      if (!item) return;

      const parent = item.parentNode;
      if (direction === 'up' && item.previousElementSibling) {
        parent.insertBefore(item, item.previousElementSibling);
      } else if (direction === 'down' && item.nextElementSibling) {
        parent.insertBefore(item.nextElementSibling, item);
      }

      updateOrderNumbers();
    }

    function updateOrderNumbers() {
      const items = document.querySelectorAll('.lecture-item');
      items.forEach((item, index) => {
        const orderBadge = item.querySelector('.lecture-order');
        if (orderBadge) {
          orderBadge.textContent = index + 1;
        }

        // Update move button states
        const upBtn = item.querySelector('.move-btn:first-child');
        const downBtn = item.querySelector('.move-btn:last-child');
        if (upBtn) upBtn.disabled = index === 0;
        if (downBtn) downBtn.disabled = index === items.length - 1;
      });

      orderChanged = true;
      document.getElementById('saveOrderBtn').classList.add('visible');
    }

    async function saveOrder() {
      const items = document.querySelectorAll('.lecture-item');
      const lectureIds = Array.from(items).map(item => item.dataset.id);

      const saveBtn = document.getElementById('saveOrderBtn');
      saveBtn.textContent = msgs.saving;
      saveBtn.disabled = true;

      try {
        const response = await fetch(`/admin/series/${seriesId}/reorder-lectures`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ lectureIds })
        });

        const result = await response.json();

        if (result.success) {
          saveBtn.textContent = msgs.saved;
          orderChanged = false;
          setTimeout(() => {
            saveBtn.textContent = msgs.saveOrder;
            saveBtn.classList.remove('visible');
            saveBtn.disabled = false;
          }, 2000);
        } else {
          throw new Error(result.error || msgs.unknownError);
        }
      } catch (error) {
        console.error('Save order error:', error);
        saveBtn.textContent = msgs.saveFailed;
        saveBtn.disabled = false;
        setTimeout(() => {
          saveBtn.textContent = msgs.saveOrder;
        }, 2000);
      }
    }

    // Remove lecture from series (doesn't delete the lecture)
    async function removeLectureFromSeries(lectureId, title) {
      if (!confirm(`${msgs.confirmRemove} "${title}..." ${msgs.fromSeries}${msgs.removeNote}`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/lectures/${lectureId}/remove-from-series`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          // Remove the lecture item from the list
          const lectureItem = document.querySelector(`.lecture-item[data-id="${lectureId}"]`);
          if (lectureItem) {
            lectureItem.style.transition = 'opacity 0.3s, transform 0.3s';
            lectureItem.style.opacity = '0';
            lectureItem.style.transform = 'translateX(20px)';
            setTimeout(() => {
              lectureItem.remove();
              updateOrderNumbers();
              // Update lecture count
              const countSpan = document.querySelector('.lecture-count');
              if (countSpan) {
                const currentCount = parseInt(countSpan.textContent) - 1;
                countSpan.textContent = `${currentCount} ${msgs.lecture}`;
              }
            }, 300);
          }
        } else {
          alert(msgs.removeFailed + (result.error || msgs.unknownError));
        }
      } catch (error) {
        console.error('Remove lecture error:', error);
        alert(msgs.removeError);
      }
    }

    // Warn before leaving if order changed
    window.addEventListener('beforeunload', (e) => {
      if (orderChanged) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // ========== Create Series Modal ==========
    let sheikhsLoaded = false;

    function openCreateSeriesModal() {
      document.getElementById('createSeriesModal').classList.add('visible');
      if (!sheikhsLoaded) {
        loadSheikhs();
      }
    }

    function closeCreateSeriesModal() {
      document.getElementById('createSeriesModal').classList.remove('visible');
    }

    async function loadSheikhs() {
      try {
        const response = await fetch('/admin/api/sheikhs');
        const data = await response.json();

        if (data.success) {
          const select = document.getElementById('newSeriesSheikh');
          data.sheikhs.forEach(sheikh => {
            const option = document.createElement('option');
            option.value = sheikh._id;
            option.textContent = sheikh.nameArabic;
            select.appendChild(option);
          });
          sheikhsLoaded = true;
        }
      } catch (error) {
        console.error('Load sheikhs error:', error);
      }
    }

    async function submitCreateSeries(event) {
      event.preventDefault();

      const titleArabic = document.getElementById('newSeriesTitleArabic').value.trim();
      const titleEnglish = document.getElementById('newSeriesTitleEnglish').value.trim();
      const sheikhId = document.getElementById('newSeriesSheikh').value;
      const category = document.getElementById('newSeriesCategory').value;

      if (!titleArabic || !sheikhId) {
        alert(msgs.fillRequired);
        return;
      }

      const submitBtn = event.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = msgs.creating;

      try {
        const response = await fetch('/admin/api/series/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            titleArabic,
            titleEnglish,
            sheikhId,
            category
          })
        });

        const result = await response.json();

        if (result.success) {
          closeCreateSeriesModal();
          // Redirect to the new series edit page
          if (confirm(`${msgs.seriesCreated} "${result.series.titleArabic}" ${msgs.goToEdit}`)) {
            window.location.href = `/admin/series/${result.series._id}/edit`;
          }
        } else {
          alert(msgs.createFailed + (result.error || msgs.unknownError));
        }
      } catch (error) {
        console.error('Create series error:', error);
        alert(msgs.connError);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = msgs.createSeries;
      }
    }

    // Close modal on outside click
    document.getElementById('createSeriesModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCreateSeriesModal();
      }
    });

    // ========== Unassociated Lectures Section ==========
    let unassociatedLectures = [];
    let unassociatedLoaded = false;

    function toggleUnassociated() {
      const content = document.getElementById('unassociatedContent');
      const icon = document.getElementById('toggleIcon');

      content.classList.toggle('visible');
      icon.classList.toggle('open');

      // Load data on first open
      if (content.classList.contains('visible') && !unassociatedLoaded) {
        loadUnassociatedLectures();
      }
    }

    async function loadUnassociatedLectures() {
      const listEl = document.getElementById('unassociatedList');

      try {
        const response = await fetch('/admin/api/unassociated-lectures');
        const data = await response.json();

        if (data.success) {
          unassociatedLectures = data.lectures;
          unassociatedLoaded = true;
          renderUnassociatedLectures(unassociatedLectures);
        } else {
          listEl.innerHTML = '<div class="no-unassociated">' + msgs.loadError + '</div>';
        }
      } catch (error) {
        console.error('Load unassociated error:', error);
        listEl.innerHTML = '<div class="no-unassociated">' + msgs.connError + '</div>';
      }
    }

    function renderUnassociatedLectures(lectures) {
      const listEl = document.getElementById('unassociatedList');

      if (lectures.length === 0) {
        listEl.innerHTML = '<div class="no-unassociated">' + msgs.noUnassociated + '</div>';
        return;
      }

      listEl.innerHTML = lectures.map(lecture => `
        <div class="unassociated-item" data-id="${lecture._id}" data-title="${lecture.titleArabic || ''}">
          <div class="lecture-info">
            <div class="lecture-title">${lecture.titleArabic || msgs.noTitle}</div>
            <div class="lecture-meta">
              ${lecture.audioFileName ? 'ğŸ”Š ' + lecture.audioFileName : msgs.noAudio}
              ${lecture.duration ? ' | ' + formatDuration(lecture.duration) : ''}
            </div>
          </div>
          <div class="assign-form">
            <input type="number" id="num-${lecture._id}" placeholder="#" min="1" title="${msgs.lectureNum}">
            <button class="assign-btn" onclick="assignLecture('${lecture._id}')">
              ${msgs.addToSeries}
            </button>
          </div>
        </div>
      `).join('');
    }

    function formatDuration(seconds) {
      if (!seconds) return '';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function filterUnassociated() {
      const searchTerm = document.getElementById('searchUnassociated').value.toLowerCase();

      const filtered = unassociatedLectures.filter(lecture => {
        const title = (lecture.titleArabic || '').toLowerCase();
        const audio = (lecture.audioFileName || '').toLowerCase();
        return title.includes(searchTerm) || audio.includes(searchTerm);
      });

      renderUnassociatedLectures(filtered);
    }

    async function assignLecture(lectureId) {
      const numInput = document.getElementById(`num-${lectureId}`);
      const lectureNumber = numInput ? numInput.value : null;
      const btn = event.target;

      btn.disabled = true;
      btn.textContent = 'â³...';

      try {
        const response = await fetch(`/admin/lectures/${lectureId}/assign-to-series`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            seriesId: seriesId,
            lectureNumber: lectureNumber || null
          })
        });

        const result = await response.json();

        if (result.success) {
          // Remove from unassociated list
          const item = document.querySelector(`.unassociated-item[data-id="${lectureId}"]`);
          if (item) {
            item.style.transition = 'opacity 0.3s, transform 0.3s';
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              item.remove();
              // Update local array
              unassociatedLectures = unassociatedLectures.filter(l => l._id !== lectureId);
              if (unassociatedLectures.length === 0) {
                document.getElementById('unassociatedList').innerHTML =
                  '<div class="no-unassociated">' + msgs.noUnassociated + '</div>';
              }
            }, 300);
          }

          // Show success and suggest refresh
          alert(msgs.addSuccess);
        } else {
          btn.disabled = false;
          btn.textContent = msgs.addToSeries;
          alert(msgs.addFailed + (result.error || msgs.unknownError));
        }
      } catch (error) {
        console.error('Assign lecture error:', error);
        btn.disabled = false;
        btn.textContent = msgs.addToSeries;
        alert(msgs.connError);
      }
    }

    // ========== Toggle Publish ==========
    async function togglePublish(lectureId) {
      const btn = document.getElementById(`publish-btn-${lectureId}`);
      const statusBadge = document.querySelector(`.lecture-item[data-id="${lectureId}"] .status-badge`);

      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'â³';

      try {
        const response = await fetch(`/admin/lectures/${lectureId}/toggle-published`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
          // Update button appearance
          if (result.published) {
            btn.classList.remove('draft');
            btn.textContent = 'ğŸ‘';
            btn.title = isArabic ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø±' : 'Unpublish';
            statusBadge.className = 'status-badge status-published';
            statusBadge.textContent = msgs.published;
          } else {
            btn.classList.add('draft');
            btn.textContent = 'ğŸ‘â€ğŸ—¨';
            btn.title = isArabic ? 'Ù†Ø´Ø±' : 'Publish';
            statusBadge.className = 'status-badge status-draft';
            statusBadge.textContent = msgs.draft;
          }
        } else {
          btn.textContent = originalText;
          alert(msgs.publishFailed);
        }
      } catch (error) {
        console.error('Toggle publish error:', error);
        btn.textContent = originalText;
        alert(msgs.connError);
      } finally {
        btn.disabled = false;
      }
    }

    // ========== Inline Audio Upload ==========
    function uploadLectureAudio(lectureId, fileInput) {
      const file = fileInput.files[0];
      if (!file) return;

      const uploadBtn = document.getElementById(`upload-btn-${lectureId}`);
      const progressDiv = document.getElementById(`progress-${lectureId}`);
      const progressBar = document.getElementById(`progress-bar-${lectureId}`);
      const audioStatus = document.getElementById(`audio-status-${lectureId}`);

      // Disable upload button
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'â³';

      // Show progress bar
      progressDiv.classList.add('visible');
      progressBar.style.width = '0%';
      progressBar.className = 'inline-progress-bar';

      // Update status
      audioStatus.className = 'audio-status audio-uploading';
      audioStatus.textContent = msgs.uploading;

      // Create FormData
      const formData = new FormData();
      formData.append('audioFile', file);

      // Create XHR for progress tracking
      const xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = percent + '%';

          if (percent >= 100) {
            audioStatus.textContent = msgs.processing;
          }
        }
      });

      xhr.addEventListener('load', () => {
        try {
          const response = JSON.parse(xhr.responseText);

          if (xhr.status === 200 && response.success) {
            // Success
            progressBar.style.width = '100%';
            progressBar.classList.add('success');
            audioStatus.className = 'audio-status audio-has';
            audioStatus.textContent = msgs.hasAudio;

            // Show brief success message
            uploadBtn.textContent = 'âœ“';
            setTimeout(() => {
              uploadBtn.textContent = 'ğŸ“¤';
              uploadBtn.disabled = false;
              progressDiv.classList.remove('visible');
            }, 2000);

            // Verify duration from the uploaded URL
            verifyUploadedDuration(lectureId, response.audioUrl);

          } else {
            // Error
            showUploadError(lectureId, response.error || msgs.unknownError);
          }
        } catch (e) {
          showUploadError(lectureId, isArabic ? 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©' : 'Error processing response');
        }

        // Reset file input
        fileInput.value = '';
      });

      xhr.addEventListener('error', () => {
        showUploadError(lectureId, isArabic ? 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection failed');
        fileInput.value = '';
      });

      xhr.addEventListener('timeout', () => {
        showUploadError(lectureId, isArabic ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©' : 'Timeout');
        fileInput.value = '';
      });

      // Send request
      xhr.open('POST', `/admin/api/lectures/${lectureId}/upload-audio`);
      xhr.timeout = 600000; // 10 minutes
      xhr.send(formData);
    }

    function showUploadError(lectureId, message) {
      const uploadBtn = document.getElementById(`upload-btn-${lectureId}`);
      const progressDiv = document.getElementById(`progress-${lectureId}`);
      const progressBar = document.getElementById(`progress-bar-${lectureId}`);
      const audioStatus = document.getElementById(`audio-status-${lectureId}`);

      progressBar.classList.add('error');
      audioStatus.className = 'audio-status audio-none';
      audioStatus.textContent = msgs.uploadFailed;

      uploadBtn.textContent = 'ğŸ“¤';
      uploadBtn.disabled = false;

      setTimeout(() => {
        progressDiv.classList.remove('visible');
        audioStatus.textContent = msgs.noAudioStatus;
      }, 3000);

      console.error('Upload error:', message);
    }

    function verifyUploadedDuration(lectureId, audioUrl) {
      const audio = new Audio();
      audio.src = audioUrl;
      audio.addEventListener('loadedmetadata', () => {
        const duration = Math.floor(audio.duration);

        // Update duration in lecture meta
        const lectureItem = document.querySelector(`.lecture-item[data-id="${lectureId}"]`);
        if (lectureItem) {
          const metaDiv = lectureItem.querySelector('.lecture-meta');
          const durationLabel = msgs.duration;
          if (metaDiv && !metaDiv.textContent.includes(durationLabel)) {
            const mins = Math.floor(duration / 60);
            const secs = duration % 60;
            metaDiv.innerHTML += ` | ${durationLabel}: ${mins}:${String(secs).padStart(2, '0')}`;
          }
        }

        // Send to server to update database
        fetch(`/api/lectures/${lectureId}/verify-duration`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duration: duration })
        }).catch(err => console.error('Duration verify error:', err));
      });
    }
  </script>
</body>
</html>
