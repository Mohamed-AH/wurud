<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Duroos</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    .header {
      background: #1A5F5A;
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-nav { display: flex; align-items: center; gap: 16px; }
    .header-nav a { color: white; text-decoration: none; opacity: 0.9; }
    .header-nav a:hover { opacity: 1; }
    .container { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }
    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-bottom: 24px;
    }
    .section h2 { font-size: 20px; margin-bottom: 16px; color: #2C3E35; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #f8f8f8; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { font-weight: 600; color: #666; font-size: 13px; text-transform: uppercase; }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-hidden { background: #f8d7da; color: #721c24; }
    .actions { display: flex; gap: 8px; }
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:hover { background: #d32f2f; }
    .btn-primary { background: #1A5F5A; color: white; }
    .btn-primary:hover { background: #145047; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .message.show { display: block; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    @media (max-width: 768px) {
      table { font-size: 13px; }
      th, td { padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ™ï¸ Manage Lectures</h1>
    <div class="header-nav">
      <a href="/admin/dashboard">Dashboard</a>
      <a href="/admin/upload">Upload</a>
      <a href="/admin/manage">Manage</a>
      <a href="/auth/logout">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="message" id="message"></div>

    <!-- Quick Actions -->
    <div class="section">
      <h2>Quick Actions</h2>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <% if (user && user.role === 'admin') { %>
          <a href="/admin/users" class="btn btn-primary">ğŸ‘¥ Manage Users</a>
        <% } %>
        <a href="/admin/sheikhs" class="btn btn-primary">ğŸ‘¨â€ğŸ« Manage Sheikhs</a>
        <a href="/admin/lectures" class="btn btn-primary">ğŸ™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</a>
        <a href="/admin/lectures/unpublished" class="btn btn-primary">ğŸ“ Unpublished</a>
        <a href="/admin/lectures/no-audio" class="btn btn-primary">ğŸ”‡ No Audio</a>
        <a href="/admin/duration-status" class="btn btn-primary">â±ï¸ Duration Status</a>
        <a href="/admin/bulk-upload" class="btn btn-primary">ğŸ“¦ Bulk Upload</a>
        <a href="/admin/schedule" class="btn btn-primary">ğŸ“… Schedule</a>
        <a href="/admin/analytics" class="btn btn-primary">ğŸ“Š Analytics</a>
      </div>
    </div>

    <!-- Series Section -->
    <div class="section">
      <div class="section-header">
        <h2>All Series (<%= series.length %>)</h2>
        <button class="btn btn-primary" onclick="exportSeriesToExcel()">ğŸ“Š Export to Excel</button>
      </div>
      <% if (series.length > 0) { %>
        <table>
          <thead>
            <tr>
              <th>Title (Arabic)</th>
              <th>Title (English)</th>
              <th>Sheikh</th>
              <th>Category</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% series.forEach(s => { %>
              <tr>
                <td><%= s.titleArabic %></td>
                <td><%= s.titleEnglish || 'N/A' %></td>
                <td><%= s.sheikhId?.nameArabic || 'N/A' %></td>
                <td><%= s.category || 'N/A' %></td>
                <td>
                  <% if (s.isVisible === false) { %>
                    <span class="badge badge-hidden">ğŸš« Hidden</span>
                  <% } else { %>
                    <span class="badge badge-success">ğŸ‘ï¸ Visible</span>
                  <% } %>
                </td>
                <td><%= new Date(s.createdAt).toLocaleDateString() %></td>
                <td class="actions">
                  <a href="/admin/series/<%= s._id %>/edit" class="btn btn-primary">âœï¸ Edit</a>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p style="text-align: center; padding: 48px; color: #666;">No series yet.</p>
      <% } %>
    </div>

    <!-- Lectures Section -->
    <div class="section">
      <h2>All Lectures (<%= lectures.length %>)</h2>
      <% if (lectures.length > 0) { %>
        <table>
          <thead>
            <tr>
              <th>Title (Arabic)</th>
              <th>Sheikh</th>
              <th>Series</th>
              <th>Status</th>
              <th>Plays</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% lectures.forEach(lecture => { %>
              <tr id="lecture-<%= lecture._id %>">
                <td><%= lecture.titleArabic %></td>
                <td><%= lecture.sheikhId?.nameArabic || 'N/A' %></td>
                <td><%= lecture.seriesId?.titleArabic || 'Standalone' %></td>
                <td>
                  <span class="badge <%= lecture.published ? 'badge-success' : 'badge-warning' %>" id="status-badge-<%= lecture._id %>">
                    <%= lecture.published ? 'Published' : 'Draft' %>
                  </span>
                </td>
                <td><%= lecture.playCount %></td>
                <td class="actions">
                  <a href="/admin/lectures/<%= lecture._id %>/edit" class="btn btn-primary">âœï¸ Edit</a>
                  <button class="btn btn-primary" onclick="togglePublished('<%= lecture._id %>', <%= lecture.published %>)">
                    <%= lecture.published ? 'ğŸ”’ Unpublish' : 'âœ… Publish' %>
                  </button>
                  <button class="btn btn-danger" onclick="deleteLecture('<%= lecture._id %>', '<%= lecture.titleArabic %>')">ğŸ—‘ï¸ Delete</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p style="text-align: center; padding: 48px; color: #666;">No lectures yet. Upload your first lecture!</p>
      <% } %>
    </div>
  </div>

  <script>
    const message = document.getElementById('message');

    async function togglePublished(id, currentlyPublished) {
      try {
        const response = await fetch(`/admin/lectures/${id}/toggle-published`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          showMessage(`Lecture ${data.published ? 'published' : 'unpublished'} successfully`, 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showMessage(data.message || 'Failed to toggle published status', 'error');
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
      }
    }

    async function deleteLecture(id, title) {
      if (!confirm(`Are you sure you want to delete "${title}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/lectures/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showMessage('Lecture deleted successfully', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showMessage(data.message || 'Failed to delete lecture', 'error');
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
      }
    }

    async function exportSeriesToExcel() {
      try {
        showMessage('Exporting series data...', 'success');

        const response = await fetch('/api/series/export');

        if (!response.ok) {
          throw new Error('Export failed');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `series-export-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showMessage('Series exported successfully!', 'success');
      } catch (error) {
        showMessage('Error exporting series: ' + error.message, 'error');
      }
    }

    function showMessage(text, type) {
      message.textContent = text;
      message.className = 'message show ' + type;
      setTimeout(() => message.classList.remove('show'), 5000);
    }
  </script>
</body>
</html>
