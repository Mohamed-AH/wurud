<style>
  /* Search Hero Section */
  .search-hero {
    background: linear-gradient(180deg, #5C4033 0%, #8B9D83 100%);
    padding: var(--space-2xl) var(--space-lg);
    text-align: center;
    margin-bottom: var(--space-2xl);
    border-bottom: 4px solid var(--accent-gold);
    position: relative;
    min-height: 280px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* Calligraphy watermark background */
  .search-hero::before {
    content: 'Ô∑Ω';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 200px;
    color: rgba(255, 255, 255, 0.03);
    font-family: var(--font-arabic-display);
    pointer-events: none;
    z-index: 0;
  }

  .search-hero > * {
    position: relative;
    z-index: 1;
  }

  .search-hero-quote {
    font-family: var(--font-arabic-display);
    font-size: 36px;
    font-weight: 700;
    color: #FAF7F2;
    margin-bottom: 32px;
    line-height: 1.8;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
  }

  .search-container {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    gap: var(--space-md);
  }

  .search-input {
    flex: 1;
    padding: 16px 20px;
    border: 3px solid #C19A6B;
    border-radius: 12px;
    font-family: var(--font-arabic-body);
    font-size: 18px;
    background: #F5EBE0;
    color: var(--text-primary);
    max-width: 700px;
    box-shadow: 0 8px 24px rgba(92, 64, 51, 0.15);
  }

  .search-input::placeholder {
    color: #8B7355;
  }

  .search-input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.3), 0 8px 24px rgba(92, 64, 51, 0.15);
  }

  .search-btn {
    padding: 16px 32px;
    background: var(--accent-gold);
    color: var(--primary-dark);
    border: none;
    border-radius: 8px;
    font-family: var(--font-arabic-body);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .search-btn:hover {
    background: var(--accent-amber);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-warm);
  }

  /* Lecture Count - Archive Header Style */
  .lecture-count-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-top: 32px;
    padding: 20px 0;
  }

  .count-divider {
    width: 48px;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(180, 150, 110, 0.6), transparent);
  }

  .count-text {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }

  .count-number {
    font-family: var(--font-arabic-display);
    font-size: 24px;
    font-weight: 600;
    color: rgba(250, 247, 242, 0.8);
    letter-spacing: 0.5px;
  }

  .count-label {
    font-family: var(--font-arabic-body);
    font-size: 15px;
    font-weight: 400;
    color: rgba(250, 247, 242, 0.8);
    letter-spacing: 0.3px;
  }

  /* Filter Chips */
  .filters-section {
    max-width: 1200px;
    margin: 0 auto var(--space-xl);
    padding: var(--space-lg);
    background: #F5EBE0;
    border-bottom: 2px solid #E8DCC8;
  }

  .filter-group {
    margin-bottom: 16px;
  }

  .filter-group:last-child {
    margin-bottom: 0;
  }

  .filter-label {
    font-family: var(--font-arabic-display);
    font-size: 16px;
    font-weight: 600;
    color: #5C4033;
    margin-bottom: 12px;
    display: block;
  }

  .filter-chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .chip {
    padding: 8px 20px;
    border: 2px solid #C19A6B;
    border-radius: 25px;
    background: transparent;
    color: #5C4033;
    font-family: var(--font-arabic-body);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .chip:hover {
    background: rgba(193, 154, 107, 0.1);
  }

  .chip.active {
    background: #C19A6B;
    color: #2C1810;
    font-weight: 600;
    box-shadow: 0 4px 8px rgba(92, 64, 51, 0.15);
  }

  .clear-filters-btn {
    padding: 8px 16px;
    border: 2px solid #dc3545;
    border-radius: 25px;
    background: transparent;
    color: #dc3545;
    font-family: var(--font-arabic-body);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-right: auto;
  }

  .clear-filters-btn:hover {
    background: #dc3545;
    color: white;
  }

  /* Series Cards */
  .series-list {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-lg) var(--space-3xl);
  }

  .series-card {
    background: #F5EBE0;
    border: 3px solid #D4A574;
    border-radius: 16px;
    margin-bottom: 24px;
    overflow: hidden;
    box-shadow: 0 6px 16px rgba(92, 64, 51, 0.15);
    transition: all 0.4s ease;
    position: relative;
  }

  /* Vertical gold accent bar */
  .series-card::before {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 6px;
    background: linear-gradient(180deg, #C19A6B 0%, #D4A574 100%);
    box-shadow: -2px 0 8px rgba(92, 64, 51, 0.15);
  }

  .series-card:hover {
    border-color: #C19A6B;
    box-shadow: 0 12px 32px rgba(92, 64, 51, 0.25);
    transform: translateY(-4px);
  }

  .series-header {
    padding: 24px;
    padding-right: calc(24px + 12px);
    background: linear-gradient(135deg, rgba(193, 154, 107, 0.1) 0%, rgba(212, 165, 116, 0.05) 100%);
    border-bottom: 2px solid #E8DCC8;
    cursor: pointer;
  }

  .series-title {
    font-family: var(--font-arabic-display);
    font-size: 24px;
    font-weight: 700;
    color: #2C1810;
    margin-bottom: 8px;
    line-height: 1.5;
  }

  .series-meta {
    margin-bottom: 16px;
  }

  /* Prominent author display - CRITICAL FIX */
  .series-author {
    font-family: var(--font-arabic-display);
    font-size: 18px;
    color: #C19A6B;
    font-weight: 600;
    line-height: 1.6;
    margin-bottom: 8px;
  }

  .series-author-label {
    color: #5C4033;
    font-weight: 500;
  }

  .series-sheikh {
    font-size: 15px;
    color: #5C4033;
    margin-bottom: 8px;
  }

  .series-info {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: #8B7355;
    align-items: center;
    padding-top: 8px;
    border-top: 1px solid #E8DCC8;
  }

  .series-info span:not(:last-child)::after {
    content: '‚Ä¢';
    margin-left: 16px;
  }

  .category-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    background: #FAF7F2;
    color: #5C6B54;
    border: 2px solid #8B9D83;
  }

  .expand-btn {
    margin-top: 16px;
    padding: 16px;
    background: transparent;
    border: none;
    border-top: 2px solid #E8DCC8;
    border-radius: 0;
    color: #C19A6B;
    font-family: var(--font-arabic-display);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .expand-btn:hover {
    background: rgba(193, 154, 107, 0.1);
  }

  .expand-btn.expanded {
    background: rgba(193, 154, 107, 0.1);
  }

  /* Episodes List - CLS-safe animation approach */
  .episodes-list {
    background: #F5EBE0;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
    opacity: 0;
  }

  .episodes-list.show {
    max-height: 10000px; /* Large enough for any content */
    overflow: visible;
    opacity: 1;
    transition: max-height 0.5s ease-in, opacity 0.3s ease-in;
  }

  /* More specific selector for Khutba tab to ensure proper display */
  #content-khutbas .episodes-list.show {
    max-height: 10000px;
    overflow: visible;
    opacity: 1;
  }

  .episode-item {
    padding: 24px;
    padding-right: calc(24px + 12px);
    border-bottom: 2px solid #E8DCC8;
    transition: background 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .episode-item:last-child {
    border-bottom: none;
  }

  .episode-item:hover {
    background: rgba(193, 154, 107, 0.05);
  }

  .episode-header {
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  .episode-number {
    width: 32px;
    height: 32px;
    background: #C19A6B;
    color: #2C1810;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
  }

  .episode-title {
    font-family: var(--font-arabic-body);
    font-size: 18px;
    font-weight: 600;
    color: #2C1810;
    flex: 1;
    line-height: 1.5;
  }

  .episode-meta {
    font-size: 14px;
    color: #8B7355;
    display: flex;
    flex-wrap: wrap;
    gap: 8px 16px;
    align-items: center;
  }

  .episode-meta span:not(:last-child)::after {
    content: '‚Ä¢';
    margin-left: 16px;
  }

  .hijri-date {
    color: #5C4033;
    font-weight: 500;
  }

  .episode-actions {
    display: flex;
    gap: 12px;
  }

  .btn-play, .btn-download {
    padding: 10px 24px;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-play {
    background: #C19A6B;
    color: #2C1810;
    border: none;
    flex: 1;
    box-shadow: 0 4px 12px rgba(92, 64, 51, 0.15);
  }

  .btn-play:hover {
    background: #D4A574;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(92, 64, 51, 0.25);
  }

  .btn-download {
    background: transparent;
    border: 2px solid #C19A6B;
    color: #C19A6B;
    min-width: 120px;
  }

  .btn-download:hover {
    background: #C19A6B;
    color: #2C1810;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-3xl);
    color: var(--text-muted);
  }

  .empty-icon {
    font-size: 64px;
    margin-bottom: var(--space-md);
  }

  .empty-title {
    font-family: var(--font-arabic-display);
    font-size: 24px;
    font-weight: 600;
    margin-bottom: var(--space-sm);
    color: var(--text-secondary);
  }

  .empty-text {
    font-size: 16px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .search-hero {
      min-height: 200px;
      padding: var(--space-lg) var(--space-md);
    }

    .search-hero-quote {
      font-size: 20px;
      margin-bottom: 20px;
      padding: 0 8px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.6;
    }

    .search-hero::before {
      font-size: 100px;
    }

    .search-container {
      flex-direction: column;
      padding: 0 8px;
    }

    .search-input {
      font-size: 16px;
      padding: 14px 16px;
    }

    .lecture-count-badge {
      margin-top: 20px;
      padding: 16px 0;
      gap: 12px;
    }

    .count-divider {
      width: 32px;
    }

    .count-text {
      gap: 8px;
    }

    .count-number {
      font-size: 20px;
    }

    .count-label {
      font-size: 13px;
    }

    .series-meta {
      flex-direction: column;
      align-items: flex-start;
    }

    .episode-meta {
      font-size: 13px;
      gap: 6px 12px;
    }

    .episode-meta span:not(:last-child)::after {
      margin-left: 12px;
    }

    .hijri-date {
      font-size: 12px;
    }

    .episode-actions {
      flex-direction: column;
    }

    .btn-play, .btn-download {
      width: 100%;
      justify-content: center;
    }
  }

  /* Homepage Sections */
  .homepage-sections {
    max-width: 1200px;
    margin: 0 auto var(--space-xl);
    padding: 0 var(--space-lg);
  }

  .section-block {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: var(--space-lg);
    overflow: hidden;
    border: 1px solid #f0ebe4;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #FAF7F2 0%, #F5EBE0 100%);
    border-bottom: 2px solid var(--accent-amber);
    cursor: pointer;
    user-select: none;
  }

  .section-header:hover {
    background: linear-gradient(135deg, #F5EBE0 0%, #EDE0D0 100%);
  }

  .section-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-icon {
    font-size: 24px;
  }

  .section-title {
    font-family: 'Scheherazade New', serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--primary-dark);
    margin: 0;
  }

  .section-count {
    font-size: 14px;
    color: var(--accent-brown);
    font-weight: 600;
    background: white;
    padding: 2px 10px;
    border-radius: 12px;
    border: 1px solid var(--accent-amber);
  }

  .section-toggle {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--accent-brown);
    cursor: pointer;
    padding: 4px 8px;
    transition: transform 0.3s ease;
  }

  .section-toggle.collapsed {
    transform: rotate(180deg);
  }

  .section-content {
    transition: max-height 0.3s ease;
    overflow: hidden;
  }

  .section-content.collapsed {
    max-height: 0 !important;
  }

  .section-table {
    width: 100%;
    border-collapse: collapse;
  }

  .section-table tr {
    border-bottom: 1px solid #f0ebe4;
    transition: background 0.15s;
  }

  .section-table tr:last-child {
    border-bottom: none;
  }

  .section-table tr:hover {
    background: #faf7f2;
  }

  .section-table td {
    padding: 12px 16px;
    vertical-align: middle;
  }

  .section-series-title {
    font-family: 'Scheherazade New', serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary-dark);
    text-decoration: none;
    display: block;
  }

  .section-series-title:hover {
    color: var(--accent-brown);
    text-decoration: underline;
  }

  .section-series-subtitle {
    font-size: 13px;
    color: #888;
    margin-top: 2px;
  }

  .section-lecture-count {
    display: inline-block;
    background: #e3f2fd;
    color: #1565c0;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
  }

  .section-view-btn {
    background: var(--accent-brown);
    color: white;
    padding: 6px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
  }

  .section-view-btn:hover {
    background: #A8845C;
  }

  .section-show-more {
    display: block;
    width: 100%;
    padding: 12px;
    background: #faf7f2;
    border: none;
    border-top: 1px solid #f0ebe4;
    color: var(--accent-brown);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    font-family: 'Scheherazade New', serif;
  }

  .section-show-more:hover {
    background: #f5ebe0;
  }

  @media (max-width: 768px) {
    .homepage-sections {
      padding: 0 var(--space-md);
    }

    .section-header {
      padding: 12px 16px;
    }

    .section-title {
      font-size: 18px;
    }

    .section-table td {
      padding: 10px 12px;
    }

    .section-series-title {
      font-size: 16px;
    }

    .section-table .hide-mobile {
      display: none;
    }
  }

  /* Navigation Tabs */
  .nav-tabs {
    background: white;
    border-bottom: 2px solid var(--accent-amber);
    margin-bottom: 24px;
  }

  .nav-tabs-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: 0;
    padding: 0 16px;
  }

  .nav-tab {
    flex: 1;
    padding: 16px 24px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    transition: all 0.3s;
    font-family: var(--font-arabic);
  }

  .nav-tab:hover {
    color: var(--primary-brown);
    background: var(--cream);
  }

  .nav-tab.active {
    color: var(--primary-brown);
    background: var(--cream);
  }

  .nav-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gold);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Weekly Schedule Section - Compact Design */
  .weekly-schedule-section {
    max-width: 1200px;
    margin: 0 auto var(--space-xl);
    padding: var(--space-lg);
  }

  .schedule-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
  }

  .schedule-title {
    font-family: var(--font-arabic-display);
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .schedule-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: var(--space-md);
  }

  .schedule-tab {
    padding: 10px 20px;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    background: white;
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-secondary);
  }

  .schedule-tab:hover {
    border-color: var(--accent-gold);
    color: var(--accent-gold);
  }

  .schedule-tab.active {
    background: var(--primary-dark);
    border-color: var(--primary-dark);
    color: white;
  }

  .schedule-tab-count {
    display: inline-block;
    background: rgba(193, 154, 107, 0.2);
    color: var(--accent-gold);
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 10px;
    margin-right: 6px;
  }

  .schedule-tab.active .schedule-tab-count {
    background: rgba(255, 255, 255, 0.2);
    color: white;
  }

  .schedule-panel {
    display: none;
  }

  .schedule-panel.active {
    display: block;
  }

  .schedule-table-wrapper {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px var(--shadow-warm);
    overflow: hidden;
    border: 2px solid var(--border-light);
  }

  .schedule-table {
    width: 100%;
    border-collapse: collapse;
  }

  .schedule-table th {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-brown) 100%);
    color: var(--cream);
    font-weight: 600;
    padding: 14px 16px;
    text-align: right;
    font-size: 14px;
  }

  .schedule-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    vertical-align: middle;
  }

  .schedule-table tr:last-child td {
    border-bottom: none;
  }

  .schedule-table tr:hover td {
    background: rgba(193, 154, 107, 0.05);
  }

  .schedule-day-cell {
    font-weight: 600;
    color: var(--primary-brown);
    white-space: nowrap;
  }

  .schedule-day-cell .day-short {
    display: none;
  }

  .schedule-time-cell {
    color: var(--text-muted);
    font-size: 13px;
    white-space: nowrap;
  }

  .schedule-time-cell .time-short {
    display: none;
  }

  .schedule-series-cell a {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .schedule-series-cell a:hover {
    color: var(--accent-gold);
  }

  .schedule-lesson-num {
    display: inline-block;
    background: var(--accent-gold);
    color: var(--primary-dark);
    font-size: 12px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 12px;
    min-width: 45px;
    text-align: center;
  }

  .new-badge {
    display: inline-block;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 8px;
    margin-right: 6px;
    vertical-align: middle;
  }

  .schedule-latest-link {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .schedule-latest-link a {
    color: var(--accent-gold);
    text-decoration: none;
  }

  .schedule-latest-link a:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .schedule-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .schedule-title {
      font-size: 20px;
    }

    .schedule-tabs {
      width: 100%;
    }

    .schedule-tab {
      flex: 1;
      text-align: center;
      padding: 8px 12px;
      font-size: 13px;
    }

    .schedule-table th,
    .schedule-table td {
      padding: 8px 10px;
      font-size: 12px;
    }

    .schedule-day-cell .day-full {
      display: none;
    }

    .schedule-day-cell .day-short {
      display: inline;
    }

    .schedule-time-cell .time-full {
      display: none;
    }

    .schedule-time-cell .time-short {
      display: inline;
    }

    .schedule-lesson-num {
      font-size: 11px;
      padding: 3px 8px;
      min-width: 40px;
    }
  }

  @media (max-width: 768px) {
    .nav-tab {
      font-size: 14px;
      padding: 12px 16px;
    }
  }

  /* Small phones (below 480px) */
  @media (max-width: 480px) {
    .search-hero {
      min-height: 180px;
      padding: var(--space-md) var(--space-sm);
    }

    .search-hero-quote {
      font-size: 17px;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .search-hero::before {
      font-size: 80px;
    }

    .search-container {
      padding: 0 4px;
    }

    .search-input {
      font-size: 15px;
      padding: 12px 14px;
    }

    .search-btn {
      padding: 12px 20px;
      font-size: 14px;
    }

    .lecture-count-badge {
      gap: 8px;
      margin-top: 16px;
      padding: 12px 0;
    }

    .count-divider {
      width: 24px;
    }

    .count-number {
      font-size: 18px;
    }

    .count-label {
      font-size: 12px;
    }

    /* Navigation tabs - smaller */
    .nav-tabs-container {
      padding: 0 8px;
    }

    .nav-tab {
      font-size: 13px;
      padding: 10px 8px;
    }

    /* Schedule - compact */
    .weekly-schedule-section {
      padding: var(--space-md);
    }

    .schedule-title {
      font-size: 18px;
    }

    .schedule-tab {
      padding: 6px 10px;
      font-size: 12px;
    }

    .schedule-table th,
    .schedule-table td {
      padding: 6px 8px;
      font-size: 11px;
    }

    .schedule-lesson-num {
      font-size: 10px;
      padding: 2px 6px;
      min-width: 36px;
    }

    /* Sections - compact */
    .homepage-sections {
      padding: 0 var(--space-sm);
    }

    .section-header {
      padding: 10px 12px;
    }

    .section-title {
      font-size: 16px;
    }

    .section-table td {
      padding: 8px 10px;
    }

    .section-series-title {
      font-size: 14px;
    }

    .section-series-subtitle {
      font-size: 11px;
    }
  }

  /* Very small phones (below 360px) */
  @media (max-width: 360px) {
    .search-hero {
      min-height: 160px;
      padding: var(--space-sm);
    }

    .search-hero-quote {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .search-hero::before {
      font-size: 60px;
    }

    .search-input {
      font-size: 14px;
      padding: 10px 12px;
    }

    .search-btn {
      padding: 10px 16px;
      font-size: 13px;
    }

    .lecture-count-badge {
      flex-direction: column;
      gap: 4px;
    }

    .count-divider {
      width: 40px;
      height: 1px;
    }

    .count-number {
      font-size: 16px;
    }

    .count-label {
      font-size: 11px;
    }

    /* Navigation tabs - stack or scroll */
    .nav-tabs-container {
      padding: 0 4px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .nav-tab {
      font-size: 12px;
      padding: 8px 6px;
      white-space: nowrap;
      flex: none;
      min-width: auto;
    }

    /* Schedule - minimal */
    .schedule-title {
      font-size: 16px;
    }

    .schedule-tabs {
      flex-wrap: wrap;
      gap: 4px;
    }

    .schedule-tab {
      padding: 5px 8px;
      font-size: 11px;
    }

    .schedule-table th,
    .schedule-table td {
      padding: 5px 6px;
      font-size: 10px;
    }

    .schedule-lesson-num {
      font-size: 9px;
      padding: 2px 4px;
      min-width: 32px;
    }

    /* Sections - minimal */
    .section-header {
      padding: 8px 10px;
    }

    .section-title {
      font-size: 14px;
    }

    .section-table td {
      padding: 6px 8px;
    }

    .section-series-title {
      font-size: 13px;
    }

    .section-series-subtitle {
      font-size: 10px;
    }

    .section-show-more {
      font-size: 12px;
      padding: 8px;
    }
  }

  /* Skeleton loading styles */
  .series-skeleton {
    padding: 0 var(--space-lg);
  }
  .skeleton-card {
    background: var(--cream);
    border: 2px solid var(--border-light);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
  }
  .skeleton-header {
    height: 28px;
    background: linear-gradient(90deg, var(--border-light) 25%, var(--cream) 50%, var(--border-light) 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
    border-radius: 6px;
    margin-bottom: 16px;
    width: 60%;
  }
  .skeleton-line {
    height: 16px;
    background: linear-gradient(90deg, var(--border-light) 25%, var(--cream) 50%, var(--border-light) 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
    border-radius: 4px;
    margin-bottom: 12px;
  }
  .skeleton-line.short {
    width: 40%;
  }
  @keyframes skeleton-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>

<!-- Search Hero -->
<div class="search-hero">
  <div class="search-hero-quote">
    <%= locale === 'ar'
      ? '"ÿ∑ŸéŸÑŸéÿ®Ÿè ÿßŸÑŸíÿπŸêŸÑŸíŸÖŸê ŸÅŸéÿ±ŸêŸäÿ∂Ÿéÿ©Ÿå ÿπŸéŸÑŸéŸâ ŸÉŸèŸÑŸêŸë ŸÖŸèÿ≥ŸíŸÑŸêŸÖŸç"'
      : '"Seeking knowledge is obligatory upon every Muslim"'
    %>
  </div>
  <div class="search-container">
    <input
      type="text"
      class="search-input"
      id="searchInput"
      placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÖŸàÿ∂Ÿàÿπÿå ÿßŸÑŸÉŸÑŸÖÿ©ÿå ÿ£Ÿà ÿßŸÑÿπŸÜŸàÿßŸÜ..."
    >
    <button class="search-btn" onclick="performSearch()">
      ÿ®ÿ≠ÿ´
    </button>
  </div>
  <% if (typeof totalLectureCount !== 'undefined' && totalLectureCount > 0) { %>
  <div class="lecture-count-badge">
    <span class="count-divider"></span>
    <span class="count-text">
      <span class="count-number"><%= totalLectureCount %>+</span>
      <span class="count-label"><%= locale === 'ar' ? 'ÿØÿ±ÿ≥ ÿµŸàÿ™Ÿä' : 'Audio Lectures' %></span>
    </span>
    <span class="count-divider"></span>
  </div>
  <% } %>
</div>

<!-- Weekly Schedule Section -->
<% if (typeof homepageConfig === 'undefined' || homepageConfig.showSchedule !== false) { %>
<% if (typeof weeklySchedule !== 'undefined' && weeklySchedule && weeklySchedule.length > 0) { %>
<%
  // Split schedule into in-person and online
  const inPersonSchedule = weeklySchedule.filter(item => !item.location.includes('ÿ®ŸèÿπÿØ') && !item.location.includes('ÿ®ÿπÿØ'));
  const onlineSchedule = weeklySchedule.filter(item => item.location.includes('ÿ®ŸèÿπÿØ') || item.location.includes('ÿ®ÿπÿØ'));

  // Day abbreviations for mobile
  const dayShort = {
    'ŸäŸàŸÖŸä': 'ŸäŸàŸÖŸä', 'ÿßŸÑÿ≥ÿ®ÿ™': 'ÿ≥ÿ®ÿ™', 'ÿßŸÑÿ£ÿ≠ÿØ': 'ÿ£ÿ≠ÿØ', 'ÿßŸÑÿßÿ´ŸÜŸäŸÜ': 'ÿ•ÿ´ŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°': 'ÿ´ŸÑÿß',
    'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°': 'ÿ£ÿ±ÿ®', 'ÿßŸÑÿÆŸÖŸäÿ≥': 'ÿÆŸÖŸä', 'ÿßŸÑÿ¨ŸÖÿπÿ©': 'ÿ¨ŸÖÿπ'
  };

  // Time abbreviations
  const timeShort = (time) => {
    return time.replace('ÿ®ÿπÿØ ÿµŸÑÿßÿ© ', '').replace('ÿßŸÑÿ≥ÿßÿπÿ© ', '').replace('ÿÆÿ∑ÿ®ÿ© ', '');
  };
%>
<section class="weekly-schedule-section">
  <div class="schedule-header">
    <h2 class="schedule-title">
      üìÖ <%= locale === 'ar' ? 'ÿ¨ÿØŸàŸÑ ÿßŸÑÿØÿ±Ÿàÿ≥ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä' : 'Weekly Class Schedule' %>
    </h2>
  </div>

  <div class="schedule-tabs">
    <button class="schedule-tab active" onclick="switchScheduleTab('inperson')">
      üïå <%= locale === 'ar' ? 'ÿ¨ÿßŸÖÿπ ÿßŸÑŸàÿ±ŸàÿØ' : 'In-Person' %>
      <span class="schedule-tab-count"><%= inPersonSchedule.length %></span>
    </button>
    <button class="schedule-tab" onclick="switchScheduleTab('online')">
      üíª <%= locale === 'ar' ? 'ÿπŸÜ ÿ®ŸèÿπÿØ' : 'Online' %>
      <span class="schedule-tab-count"><%= onlineSchedule.length %></span>
    </button>
  </div>

  <!-- In-Person Classes Panel -->
  <div id="schedule-inperson" class="schedule-panel active">
    <% if (inPersonSchedule.length > 0) { %>
    <div class="schedule-table-wrapper">
      <table class="schedule-table">
        <thead>
          <tr>
            <th><%= locale === 'ar' ? 'ÿßŸÑŸäŸàŸÖ' : 'Day' %></th>
            <th><%= locale === 'ar' ? 'ÿßŸÑŸàŸÇÿ™' : 'Time' %></th>
            <th><%= locale === 'ar' ? 'ÿßŸÑÿ≥ŸÑÿ≥ŸÑÿ©' : 'Series' %></th>
            <th><%= locale === 'ar' ? 'ÿßŸÑÿØÿ±ÿ≥ #' : 'Lesson #' %></th>
          </tr>
        </thead>
        <tbody>
          <% inPersonSchedule.forEach(function(item) { %>
          <tr>
            <td class="schedule-day-cell">
              <span class="day-full"><%= item.dayOfWeek %></span>
              <span class="day-short"><%= dayShort[item.dayOfWeek] || item.dayOfWeek %></span>
            </td>
            <td class="schedule-time-cell">
              <span class="time-full"><%= item.time %></span>
              <span class="time-short"><%= timeShort(item.time) %></span>
            </td>
            <td class="schedule-series-cell">
              <% if (item.isNew) { %><span class="new-badge"><%= locale === 'ar' ? 'ÿ¨ÿØŸäÿØ' : 'NEW' %></span><% } %>
              <a href="/series/<%= item.seriesId.slug ? encodeURIComponent(item.seriesId.slug) : item.seriesId._id %>">
                <%= locale === 'ar' ? item.seriesId.titleArabic : (item.seriesId.titleEnglish || item.seriesId.titleArabic) %>
              </a>
            </td>
            <td style="text-align: center;">
              <% if (item.latestLecture && item.latestLecture.lectureNumber) { %>
              <a href="/lectures/<%= item.latestLecture.slug ? encodeURIComponent(item.latestLecture.slug) : item.latestLecture._id %>" style="text-decoration: none;">
                <span class="schedule-lesson-num"><%= item.latestLecture.lectureNumber %></span>
              </a>
              <% } else if (item.lectureCount > 0) { %>
              <a href="/series/<%= item.seriesId.slug ? encodeURIComponent(item.seriesId.slug) : item.seriesId._id %>" style="text-decoration: none;">
                <span class="schedule-lesson-num"><%= item.lectureCount %></span>
              </a>
              <% } else { %>
              <span style="color: var(--text-muted);">-</span>
              <% } %>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <% } else { %>
    <p style="text-align: center; color: var(--text-muted); padding: 24px;"><%= locale === 'ar' ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿØÿ±Ÿàÿ≥ ÿ≠ÿ∂Ÿàÿ±Ÿäÿ© ÿ≠ÿßŸÑŸäÿßŸã' : 'No in-person classes currently' %></p>
    <% } %>
  </div>

  <!-- Online Classes Panel -->
  <div id="schedule-online" class="schedule-panel">
    <% if (onlineSchedule.length > 0) { %>
    <div class="schedule-table-wrapper">
      <table class="schedule-table">
        <thead>
          <tr>
            <th><%= locale === 'ar' ? 'ÿßŸÑŸäŸàŸÖ' : 'Day' %></th>
            <th><%= locale === 'ar' ? 'ÿßŸÑŸàŸÇÿ™' : 'Time' %></th>
            <th><%= locale === 'ar' ? 'ÿßŸÑÿ≥ŸÑÿ≥ŸÑÿ©' : 'Series' %></th>
            <th><%= locale === 'ar' ? 'ÿßŸÑÿØÿ±ÿ≥ #' : 'Lesson #' %></th>
          </tr>
        </thead>
        <tbody>
          <% onlineSchedule.forEach(function(item) { %>
          <tr>
            <td class="schedule-day-cell">
              <span class="day-full"><%= item.dayOfWeek %></span>
              <span class="day-short"><%= dayShort[item.dayOfWeek] || item.dayOfWeek %></span>
            </td>
            <td class="schedule-time-cell">
              <span class="time-full"><%= item.time %></span>
              <span class="time-short"><%= timeShort(item.time) %></span>
            </td>
            <td class="schedule-series-cell">
              <% if (item.isNew) { %><span class="new-badge"><%= locale === 'ar' ? 'ÿ¨ÿØŸäÿØ' : 'NEW' %></span><% } %>
              <a href="/series/<%= item.seriesId.slug ? encodeURIComponent(item.seriesId.slug) : item.seriesId._id %>">
                <%= locale === 'ar' ? item.seriesId.titleArabic : (item.seriesId.titleEnglish || item.seriesId.titleArabic) %>
              </a>
            </td>
            <td style="text-align: center;">
              <% if (item.latestLecture && item.latestLecture.lectureNumber) { %>
              <a href="/lectures/<%= item.latestLecture.slug ? encodeURIComponent(item.latestLecture.slug) : item.latestLecture._id %>" style="text-decoration: none;">
                <span class="schedule-lesson-num"><%= item.latestLecture.lectureNumber %></span>
              </a>
              <% } else if (item.lectureCount > 0) { %>
              <a href="/series/<%= item.seriesId.slug ? encodeURIComponent(item.seriesId.slug) : item.seriesId._id %>" style="text-decoration: none;">
                <span class="schedule-lesson-num"><%= item.lectureCount %></span>
              </a>
              <% } else { %>
              <span style="color: var(--text-muted);">-</span>
              <% } %>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <% } else { %>
    <p style="text-align: center; color: var(--text-muted); padding: 24px;"><%= locale === 'ar' ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿØÿ±Ÿàÿ≥ ÿπŸÜ ÿ®ŸèÿπÿØ ÿ≠ÿßŸÑŸäÿßŸã' : 'No online classes currently' %></p>
    <% } %>
  </div>
</section>

<script>
function switchScheduleTab(tab) {
  // Update tab buttons
  document.querySelectorAll('.schedule-tab').forEach(btn => btn.classList.remove('active'));
  event.target.closest('.schedule-tab').classList.add('active');

  // Update panels
  document.querySelectorAll('.schedule-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById('schedule-' + tab).classList.add('active');
}
</script>
<% } %>
<% } %>

<!-- Homepage Sections -->
<% if (typeof homepageSections !== 'undefined' && homepageSections && homepageSections.length > 0) { %>
<div class="homepage-sections">
  <% homepageSections.forEach(function(section) { %>
  <div class="section-block" id="section-<%= section.slug %>">
    <div class="section-header" onclick="toggleSection('<%= section.slug %>')">
      <div class="section-header-left">
        <span class="section-icon"><%= section.icon %></span>
        <h2 class="section-title"><%= locale === 'ar' ? section.title.ar : section.title.en %></h2>
        <span class="section-count"><%= section.totalSeriesCount %></span>
      </div>
      <button class="section-toggle <%= section.collapsedByDefault ? 'collapsed' : '' %>" id="toggle-<%= section.slug %>" aria-label="Toggle">&#9650;</button>
    </div>
    <div class="section-content <%= section.collapsedByDefault ? 'collapsed' : '' %>" id="content-<%= section.slug %>">
      <table class="section-table">
        <% const visibleSeries = section.series.slice(0, section.maxVisible || 5); %>
        <% const hiddenSeries = section.series.slice(section.maxVisible || 5); %>
        <% visibleSeries.forEach(function(s) { %>
        <tr>
          <td style="width:60%">
            <a href="/series/<%= s.slug %>" class="section-series-title"><%= s.titleArabic %></a>
            <% if (s.titleEnglish) { %>
              <div class="section-series-subtitle"><%= s.titleEnglish %></div>
            <% } %>
          </td>
          <td class="hide-mobile" style="width:20%">
            <% if (s.sheikh) { %>
              <span style="color:#666;font-size:14px;"><%= s.sheikh.nameArabic %></span>
            <% } %>
          </td>
          <td style="width:10%;text-align:center;">
            <span class="section-lecture-count"><%= s.lectureCount %> <%= locale === 'ar' ? 'ÿØÿ±ÿ≥' : '' %></span>
          </td>
          <td class="hide-mobile" style="width:10%;text-align:center;">
            <a href="/series/<%= s.slug %>" class="section-view-btn"><%= locale === 'ar' ? 'ÿπÿ±ÿ∂' : 'View' %></a>
          </td>
        </tr>
        <% }) %>
        <% hiddenSeries.forEach(function(s) { %>
        <tr class="section-hidden-row" data-section="<%= section.slug %>" style="display:none;">
          <td style="width:60%">
            <a href="/series/<%= s.slug %>" class="section-series-title"><%= s.titleArabic %></a>
            <% if (s.titleEnglish) { %>
              <div class="section-series-subtitle"><%= s.titleEnglish %></div>
            <% } %>
          </td>
          <td class="hide-mobile" style="width:20%">
            <% if (s.sheikh) { %>
              <span style="color:#666;font-size:14px;"><%= s.sheikh.nameArabic %></span>
            <% } %>
          </td>
          <td style="width:10%;text-align:center;">
            <span class="section-lecture-count"><%= s.lectureCount %> <%= locale === 'ar' ? 'ÿØÿ±ÿ≥' : '' %></span>
          </td>
          <td class="hide-mobile" style="width:10%;text-align:center;">
            <a href="/series/<%= s.slug %>" class="section-view-btn"><%= locale === 'ar' ? 'ÿπÿ±ÿ∂' : 'View' %></a>
          </td>
        </tr>
        <% }) %>
      </table>
      <% if (hiddenSeries.length > 0) { %>
        <button class="section-show-more" id="showmore-<%= section.slug %>" onclick="showMoreSeries('<%= section.slug %>')">
          <%= locale === 'ar' ? 'ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ' : 'Show more' %> (<%= hiddenSeries.length %>)
        </button>
      <% } %>
    </div>
  </div>
  <% }) %>
</div>

<script>
function toggleSection(slug) {
  const content = document.getElementById('content-' + slug);
  const toggle = document.getElementById('toggle-' + slug);
  content.classList.toggle('collapsed');
  toggle.classList.toggle('collapsed');
  // Persist state
  try {
    const state = JSON.parse(localStorage.getItem('sectionState') || '{}');
    state[slug] = content.classList.contains('collapsed');
    localStorage.setItem('sectionState', JSON.stringify(state));
  } catch(e) {}
}

function showMoreSeries(slug) {
  const rows = document.querySelectorAll('.section-hidden-row[data-section="' + slug + '"]');
  rows.forEach(row => row.style.display = '');
  const btn = document.getElementById('showmore-' + slug);
  if (btn) btn.style.display = 'none';
}

// Restore collapsed state from localStorage
(function() {
  try {
    const state = JSON.parse(localStorage.getItem('sectionState') || '{}');
    Object.keys(state).forEach(slug => {
      const content = document.getElementById('content-' + slug);
      const toggle = document.getElementById('toggle-' + slug);
      if (content && toggle) {
        if (state[slug]) {
          content.classList.add('collapsed');
          toggle.classList.add('collapsed');
        } else {
          content.classList.remove('collapsed');
          toggle.classList.remove('collapsed');
        }
      }
    });
  } catch(e) {}
})();
</script>
<% } %>

<!-- Navigation Tabs -->
<%
  const showSeriesTab = typeof homepageConfig === 'undefined' || homepageConfig.showSeriesTab !== false;
  const showStandaloneTab = typeof homepageConfig === 'undefined' || homepageConfig.showStandaloneTab !== false;
  const showKhutbasTab = typeof homepageConfig === 'undefined' || homepageConfig.showKhutbasTab !== false;
  const anyTabVisible = showSeriesTab || showStandaloneTab || showKhutbasTab;
%>
<% if (anyTabVisible) { %>
<div class="nav-tabs">
  <div class="nav-tabs-container">
    <% if (showSeriesTab) { %>
    <button class="nav-tab active" id="tab-series">
      üìö ÿßŸÑÿ≥ŸÑÿßÿ≥ŸÑ
    </button>
    <% } %>
    <% if (showStandaloneTab) { %>
    <button class="nav-tab" id="tab-lectures">
      üéôÔ∏è ÿßŸÑŸÖÿ≠ÿßÿ∂ÿ±ÿßÿ™
    </button>
    <% } %>
    <% if (showKhutbasTab) { %>
    <button class="nav-tab" id="tab-khutbas">
      üïå ÿßŸÑÿÆÿ∑ÿ®
    </button>
    <% } %>
  </div>
</div>

<!-- Filters -->
<div class="filters-section">
  <div class="filter-group">
    <span class="filter-label">ÿßŸÑÿ™ÿµŸÜŸäŸÅ:</span>
    <div class="filter-chips">
      <button class="chip active" data-filter="all" data-type="category">
        ÿßŸÑŸÉŸÑ
      </button>
      <button class="chip" data-filter="Fiqh" data-type="category">
        ÿßŸÑŸÅŸÇŸá
      </button>
      <button class="chip" data-filter="Aqeedah" data-type="category">
        ÿßŸÑÿπŸÇŸäÿØÿ©
      </button>
      <button class="chip" data-filter="Tafsir" data-type="category">
        ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±
      </button>
      <button class="chip" data-filter="Hadith" data-type="category">
        ÿßŸÑÿ≠ÿØŸäÿ´
      </button>
      <button class="chip" data-filter="Seerah" data-type="category">
        ÿßŸÑÿ≥Ÿäÿ±ÿ©
      </button>
      <button class="chip" data-filter="Other" data-type="category">
        ÿ£ÿÆÿ±Ÿâ
      </button>
    </div>
  </div>

  <div class="filter-group">
    <span class="filter-label">ÿßŸÑŸÜŸàÿπ:</span>
    <div class="filter-chips">
      <button class="chip active" data-filter="all" data-type="seriesType">
        ÿßŸÑŸÉŸÑ
      </button>
      <button class="chip" data-filter="online" data-type="seriesType">
        ÿπŸÜ ÿ®ÿπÿØ
      </button>
      <button class="chip" data-filter="archive-ramadan" data-type="seriesType">
        ÿ£ÿ±ÿ¥ŸäŸÅ ÿ±ŸÖÿ∂ÿßŸÜ
      </button>
      <button class="chip" data-filter="archive" data-type="seriesType">
        ÿ£ÿ±ÿ¥ŸäŸÅ
      </button>
      <button class="chip" data-filter="masjid" data-type="seriesType">
        ÿ¨ÿßŸÖÿπ ÿßŸÑŸàÿ±ŸàÿØ
      </button>
    </div>
  </div>

  <div class="filter-group">
    <span class="filter-label">ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®:</span>
    <div class="filter-chips">
      <button class="chip active" data-sort="newest">
        ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
      </button>
      <button class="chip" data-sort="oldest">
        ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã
      </button>
    </div>
  </div>

  <button class="clear-filters-btn" id="clearFiltersBtn" style="display: none;">
    ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ± ‚úï
  </button>
</div>

<!-- Series Tab Content -->
<div id="content-series" class="tab-content active">
<div class="series-list">
  <% if (typeof lazyLoadSeries !== 'undefined' && lazyLoadSeries) { %>
    <!-- Loading skeleton - series will be loaded via API -->
    <div class="series-skeleton" id="seriesLoadingSkeleton">
      <div class="skeleton-card">
        <div class="skeleton-header"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </div>
      <div class="skeleton-card">
        <div class="skeleton-header"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </div>
      <div class="skeleton-card">
        <div class="skeleton-header"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </div>
      <p style="text-align: center; color: var(--text-muted); padding: 20px;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ŸÑÿßÿ≥ŸÑ...</p>
    </div>
  <% } else if (seriesList && seriesList.length > 0) { %>
    <% seriesList.forEach(series => {
      // Get the most recent lecture date for sorting
      // Find the lecture with the latest dateRecorded
      let latestLecture = null;
      let latestDate = 0;

      if (series.lectures.length > 0) {
        // Find lecture with most recent dateRecorded
        for (const lecture of series.lectures) {
          if (lecture.dateRecorded) {
            const lectureTime = new Date(lecture.dateRecorded).getTime();
            if (lectureTime > latestDate) {
              latestDate = lectureTime;
              latestLecture = lecture;
            }
          }
        }

        // If no lectures have dateRecorded, use createdAt as fallback
        if (latestDate === 0) {
          for (const lecture of series.lectures) {
            if (lecture.createdAt) {
              const lectureTime = new Date(lecture.createdAt).getTime();
              if (lectureTime > latestDate) {
                latestDate = lectureTime;
                latestLecture = lecture;
              }
            }
          }
        }

        // Last resort: use Date.now()
        if (latestDate === 0) {
          latestDate = Date.now();
        }
      } else {
        latestDate = Date.now();
      }

      const hijriDate = latestLecture?.dateRecordedHijri || '';

      // Determine series type based on tags or title suffix
      let seriesType = 'masjid'; // default
      if (series.tags && series.tags.includes('online')) {
        seriesType = 'online';
      } else if (series.tags && series.tags.includes('ramadan')) {
        seriesType = 'archive-ramadan';
      } else if (series.tags && series.tags.includes('archive')) {
        seriesType = 'archive';
      } else if (series.titleArabic && series.titleArabic.includes('ÿπŸÜ ÿ®ÿπÿØ')) {
        seriesType = 'online';
      } else if (series.titleArabic && series.titleArabic.includes('ÿ£ÿ±ÿ¥ŸäŸÅ ÿ±ŸÖÿ∂ÿßŸÜ')) {
        seriesType = 'archive-ramadan';
      } else if (series.titleArabic && series.titleArabic.includes('ÿ£ÿ±ÿ¥ŸäŸÅ')) {
        seriesType = 'archive';
      }
    %>
      <div class="series-card" data-category="<%= series.category %>" data-date="<%= latestDate %>" data-hijri="<%= hijriDate %>" data-series-type="<%= seriesType %>">
        <div class="series-header" onclick="toggleSeries('<%= series._id %>')">
          <h2 class="series-title"><%= series.titleArabic %></h2>

          <div class="series-meta">
            <% if (series.originalAuthor) { %>
              <div class="series-author">
                <span class="series-author-label">ÿßŸÑŸÖÿ§ŸÑŸÅ:</span>
                <%= series.originalAuthor %>
              </div>
            <% } %>
            <div class="series-sheikh">
              ÿßŸÑÿ¥ŸäÿÆ:
              <%= series.sheikh ? series.sheikh.nameArabic : '' %>
            </div>
          </div>

          <div class="series-info">
            <span><%= series.lectureCount %> ÿØÿ±ÿ≥</span>
            <span class="category-badge">
              <%
                const categoryArabic = {
                  'Tafsir': 'ÿ™ŸÅÿ≥Ÿäÿ±',
                  'Hadith': 'ÿ≠ÿØŸäÿ´',
                  'Fiqh': 'ŸÅŸÇŸá',
                  'Aqeedah': 'ÿπŸÇŸäÿØÿ©',
                  'Seerah': 'ÿ≥Ÿäÿ±ÿ©',
                  'Akhlaq': 'ÿ£ÿÆŸÑÿßŸÇ',
                  'Other': 'ÿ£ÿÆÿ±Ÿâ'
                };
              %>
              <%= categoryArabic[series.category] || series.category || 'ÿ£ÿÆÿ±Ÿâ' %>
            </span>
          </div>

          <button class="expand-btn" id="btn-<%= series._id %>">
            ÿπÿ±ÿ∂ ÿßŸÑÿØÿ±Ÿàÿ≥ ‚ñº
          </button>
        </div>

        <div class="episodes-list" id="episodes-<%= series._id %>">
          <!-- Sort controls for lectures within this series -->
          <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 13px; font-weight: 600; color: #666;">ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿØÿ±Ÿàÿ≥:</span>
            <button class="chip" onclick="sortSeriesLectures('<%= series._id %>', 'number'); event.stopPropagation();" style="padding: 4px 12px; font-size: 12px;">
              ÿ≠ÿ≥ÿ® ÿßŸÑÿ±ŸÇŸÖ
            </button>
            <button class="chip" onclick="sortSeriesLectures('<%= series._id %>', 'oldest'); event.stopPropagation();" style="padding: 4px 12px; font-size: 12px;">
              ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã
            </button>
            <button class="chip" onclick="sortSeriesLectures('<%= series._id %>', 'newest'); event.stopPropagation();" style="padding: 4px 12px; font-size: 12px;">
              ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
            </button>
          </div>

          <div class="episodes-container">
          <% series.lectures.forEach((lecture, index) => { %>
            <div class="episode-item" data-lecture-number="<%= index + 1 %>" data-date="<%= lecture.dateRecorded ? new Date(lecture.dateRecorded).getTime() : 0 %>">
              <div class="episode-header">
                <div class="episode-number"><%= index + 1 %></div>
                <div class="episode-title">
                  <%= lecture.titleArabic %>
                </div>
              </div>
              <div class="episode-meta">
                <% if (lecture.duration && lecture.duration > 0) { %>
                  <span>‚è±Ô∏è <%= Math.floor(lecture.duration / 60) %>:<%= String(lecture.duration % 60).padStart(2, '0') %></span>
                <% } %>
                <% if (lecture.location) { %>
                  <span><%= lecture.location %></span>
                <% } %>
                <% if (lecture.dateRecordedHijri) { %>
                  <span class="hijri-date">üìÖ <%= formatHijriDate(lecture.dateRecordedHijri) %></span>
                <% } %>
              </div>
              <div class="episode-actions">
                <button class="btn-play" onclick="playAudio('<%= lecture._id %>', '<%= lecture.titleArabic.replace(/'/g, "\\'") %>', '<%= series.sheikh ? series.sheikh.nameArabic.replace(/'/g, "\\'") : "" %>')">
                  ‚ñ∂ <%= locale === 'ar' ? 'ÿ™ÿ¥ÿ∫ŸäŸÑ' : 'Play' %>
                </button>
                <a href="/download/<%= lecture._id %>" class="btn-download">
                  ‚¨á <%= locale === 'ar' ? 'ÿ™ÿ≠ŸÖŸäŸÑ' : 'Download' %>
                </a>
              </div>
            </div>
          <% }); %>
          </div><!-- Close episodes-container -->
        </div>
      </div>
    <% }); %>
  <% } else { %>
    <div class="empty-state">
      <div class="empty-icon">üìö</div>
      <h3 class="empty-title">
        ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿßÿ∂ÿ±ÿßÿ™
      </h3>
      <p class="empty-text">
        ÿ¨ÿ±ÿ® ÿ®ÿ≠ÿ´ÿßŸã ÿ¢ÿÆÿ±
      </p>
    </div>
  <% } %>
</div>
</div>

<!-- Lectures Tab Content -->
<div id="content-lectures" class="tab-content">
  <div class="series-list">
    <% if (standaloneLectures && standaloneLectures.length > 0) { %>
      <% standaloneLectures.forEach(lecture => {
        // Use dateRecorded if available, otherwise createdAt, otherwise Date.now()
        let lectureDate;
        if (lecture.dateRecorded) {
          lectureDate = new Date(lecture.dateRecorded).getTime();
        } else if (lecture.createdAt) {
          lectureDate = new Date(lecture.createdAt).getTime();
        } else {
          lectureDate = Date.now();
        }

        const hijriDate = lecture.dateRecordedHijri || '';
      %>
        <div class="series-card" data-date="<%= lectureDate %>" data-hijri="<%= hijriDate %>">
          <div class="series-header">
            <h2 class="series-title"><%= lecture.titleArabic %></h2>
            <div class="series-meta">
              <div class="series-sheikh">
                ÿßŸÑÿ¥ŸäÿÆ: <%= lecture.sheikhId ? lecture.sheikhId.nameArabic : '' %>
              </div>
            </div>
            <div class="series-info">
              <% if (lecture.duration && lecture.duration > 0) { %>
                <span>‚è±Ô∏è <%= Math.floor(lecture.duration / 60) %>:<%= String(lecture.duration % 60).padStart(2, '0') %></span>
              <% } %>
              <% if (lecture.dateRecordedHijri) { %>
                <span class="hijri-date">üìÖ <%= formatHijriDate(lecture.dateRecordedHijri) %></span>
              <% } %>
            </div>
            <div class="episode-actions" style="margin-top: 16px;">
              <% if (lecture.audioFileName) { %>
                <button class="btn-play" onclick="playAudio('<%= lecture._id %>', '<%= lecture.titleArabic.replace(/'/g, "\\'") %>', '<%= lecture.sheikhId ? lecture.sheikhId.nameArabic.replace(/'/g, "\\'") : "" %>')">
                  ‚ñ∂ ÿ™ÿ¥ÿ∫ŸäŸÑ
                </button>
                <a href="/download/<%= lecture._id %>" class="btn-download">
                  ‚¨á ÿ™ÿ≠ŸÖŸäŸÑ
                </a>
              <% } %>
            </div>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-icon">üéôÔ∏è</div>
        <h3 class="empty-title">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿßÿ∂ÿ±ÿßÿ™ ŸÖŸÜŸÅÿµŸÑÿ©</h3>
      </div>
    <% } %>
  </div>
</div>

<!-- Khutbas Tab Content -->
<div id="content-khutbas" class="tab-content">
  <div class="series-list">
    <% if (khutbaSeries && khutbaSeries.length > 0) { %>
      <% khutbaSeries.forEach(series => {
        // Get the most recent lecture date for sorting
        // Find the lecture with the latest dateRecorded
        let latestLecture = null;
        let latestDate = 0;

        if (series.lectures.length > 0) {
          // Find lecture with most recent dateRecorded
          for (const lecture of series.lectures) {
            if (lecture.dateRecorded) {
              const lectureTime = new Date(lecture.dateRecorded).getTime();
              if (lectureTime > latestDate) {
                latestDate = lectureTime;
                latestLecture = lecture;
              }
            }
          }

          // If no lectures have dateRecorded, use createdAt as fallback
          if (latestDate === 0) {
            for (const lecture of series.lectures) {
              if (lecture.createdAt) {
                const lectureTime = new Date(lecture.createdAt).getTime();
                if (lectureTime > latestDate) {
                  latestDate = lectureTime;
                  latestLecture = lecture;
                }
              }
            }
          }

          // Last resort: use Date.now()
          if (latestDate === 0) {
            latestDate = Date.now();
          }
        } else {
          latestDate = Date.now();
        }

        const hijriDate = latestLecture?.dateRecordedHijri || '';
      %>
        <div class="series-card" data-category="<%= series.category %>" data-date="<%= latestDate %>" data-hijri="<%= hijriDate %>">
          <div class="series-header" onclick="toggleKhutba('<%= series._id %>')">
            <h2 class="series-title"><%= series.titleArabic %></h2>
            <div class="series-meta">
              <div class="series-sheikh">
                ÿßŸÑÿ¥ŸäÿÆ: <%= series.sheikh ? series.sheikh.nameArabic : '' %>
              </div>
            </div>
            <div class="series-info">
              <span><%= series.lectureCount %> ÿÆÿ∑ÿ®ÿ©</span>
            </div>
            <button class="expand-btn" id="khutba-btn-<%= series._id %>">
              ÿπÿ±ÿ∂ ÿßŸÑÿÆÿ∑ÿ® ‚ñº
            </button>
          </div>
          <div class="episodes-list" id="khutba-episodes-<%= series._id %>">
            <!-- Sort controls for khutbas within this series -->
            <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; gap: 8px; align-items: center;">
              <span style="font-size: 13px; font-weight: 600; color: #666;">ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿÆÿ∑ÿ®:</span>
              <button class="chip" onclick="sortSeriesLectures('khutba-<%= series._id %>', 'number'); event.stopPropagation();" style="padding: 4px 12px; font-size: 12px;">
                ÿ≠ÿ≥ÿ® ÿßŸÑÿ±ŸÇŸÖ
              </button>
              <button class="chip" onclick="sortSeriesLectures('khutba-<%= series._id %>', 'oldest'); event.stopPropagation();" style="padding: 4px 12px; font-size: 12px;">
                ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã
              </button>
              <button class="chip" onclick="sortSeriesLectures('khutba-<%= series._id %>', 'newest'); event.stopPropagation();" style="padding: 4px 12px; font-size: 12px;">
                ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
              </button>
            </div>

            <div class="episodes-container">
            <% if (series.lectures && series.lectures.length > 0) { %>
              <% series.lectures.forEach((lecture, index) => { %>
                <div class="episode-item" data-lecture-number="<%= index + 1 %>" data-date="<%= lecture.dateRecorded ? new Date(lecture.dateRecorded).getTime() : 0 %>">
                  <div class="episode-header">
                    <div class="episode-number"><%= index + 1 %></div>
                    <div class="episode-title"><%= lecture.titleArabic %></div>
                  </div>
                  <div class="episode-meta">
                    <% if (lecture.duration && lecture.duration > 0) { %>
                      <span>‚è±Ô∏è <%= Math.floor(lecture.duration / 60) %>:<%= String(lecture.duration % 60).padStart(2, '0') %></span>
                    <% } %>
                    <% if (lecture.location) { %>
                      <span><%= lecture.location %></span>
                    <% } %>
                    <% if (lecture.dateRecordedHijri) { %>
                      <span class="hijri-date">üìÖ <%= formatHijriDate(lecture.dateRecordedHijri) %></span>
                    <% } %>
                  </div>
                  <div class="episode-actions">
                    <% if (lecture.audioFileName) { %>
                      <button class="btn-play" onclick="playAudio('<%= lecture._id %>', '<%= lecture.titleArabic.replace(/'/g, "\\'") %>', '<%= series.sheikh ? series.sheikh.nameArabic.replace(/'/g, "\\'") : "" %>')">
                        ‚ñ∂ <%= locale === 'ar' ? 'ÿ™ÿ¥ÿ∫ŸäŸÑ' : 'Play' %>
                      </button>
                      <a href="/download/<%= lecture._id %>" class="btn-download">
                        ‚¨á <%= locale === 'ar' ? 'ÿ™ÿ≠ŸÖŸäŸÑ' : 'Download' %>
                      </a>
                    <% } %>
                  </div>
                </div>
              <% }) %>
            <% } %>
            </div><!-- Close episodes-container -->
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-icon">üïå</div>
        <h3 class="empty-title"><%= locale === 'ar' ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆÿ∑ÿ®' : 'No Khutbahs' %></h3>
      </div>
    <% } %>
  </div>
</div>
<% } %><!-- end anyTabVisible -->

<script>
  // Toggle series expansion
  function toggleSeries(seriesId) {
    const episodesList = document.getElementById('episodes-' + seriesId);
    const btn = document.getElementById('btn-' + seriesId);

    if (!episodesList || !btn) return;

    episodesList.classList.toggle('show');
    btn.classList.toggle('expanded');

    if (episodesList.classList.contains('show')) {
      btn.textContent = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿØÿ±Ÿàÿ≥ ‚ñ≤';
    } else {
      btn.textContent = 'ÿπÿ±ÿ∂ ÿßŸÑÿØÿ±Ÿàÿ≥ ‚ñº';
    }
  }

  // Toggle Khutba expansion
  function toggleKhutba(seriesId) {
    const episodesList = document.getElementById('khutba-episodes-' + seriesId);
    const btn = document.getElementById('khutba-btn-' + seriesId);

    if (!episodesList || !btn) return;

    episodesList.classList.toggle('show');
    btn.classList.toggle('expanded');

    if (episodesList.classList.contains('show')) {
      btn.textContent = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿÆÿ∑ÿ® ‚ñ≤';
    } else {
      btn.textContent = 'ÿπÿ±ÿ∂ ÿßŸÑÿÆÿ∑ÿ® ‚ñº';
    }
  }

  // Play audio using sticky audio player
  function playAudio(lectureId, title, sheikh) {
    if (window.audioPlayer) {
      window.audioPlayer.play(lectureId, {
        title: title,
        titleArabic: title,
        sheikh: sheikh || ''
      });
    } else {
      alert('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿ∫ŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
    }
  }

  // Sort lectures within a specific series
  function sortSeriesLectures(seriesId, sortType) {
    // Get the episodes container for this series
    let episodesListId;
    if (seriesId.startsWith('khutba-')) {
      episodesListId = `khutba-episodes-${seriesId.substring(7)}`;
    } else {
      episodesListId = `episodes-${seriesId}`;
    }
    const episodesList = document.getElementById(episodesListId);
    if (!episodesList) return;

    const container = episodesList.querySelector('.episodes-container');
    if (!container) return;

    // Get all episode items
    const episodes = Array.from(container.querySelectorAll('.episode-item'));

    // Sort episodes based on type
    episodes.sort((a, b) => {
      if (sortType === 'number') {
        const numA = parseInt(a.dataset.lectureNumber) || 999;
        const numB = parseInt(b.dataset.lectureNumber) || 999;
        return numA - numB;
      } else if (sortType === 'oldest') {
        const dateA = parseInt(a.dataset.date) || 0;
        const dateB = parseInt(b.dataset.date) || 0;
        return dateA - dateB;
      } else if (sortType === 'newest') {
        const dateA = parseInt(a.dataset.date) || 0;
        const dateB = parseInt(b.dataset.date) || 0;
        return dateB - dateA;
      }
      return 0;
    });

    // Re-append episodes in sorted order
    episodes.forEach(episode => container.appendChild(episode));
  }
</script>

<!-- Server-side filtering and pagination module (minified) -->
<script src="/js/homepage.min.js" defer></script>
